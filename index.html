<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‡Œå† ä¼šå‘˜ä¿¡æ¯è¡¨</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        body { padding: 20px; background-color: #f8f9fa; }
        .tab-content { margin-top: 20px; }
        .filter-area { background: #fff; padding: 15px; border-radius: 5px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .time-control { 
            background: #fff; 
            padding: 15px; 
            border-radius: 5px; 
            margin-bottom: 20px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        table th { text-align: center; background-color: #f1f3f4; }
        table td { vertical-align: middle; text-align: center; }
        .operation-btn { display: flex; gap: 5px; justify-content: center; flex-wrap: wrap; }
        .clear-data-area { 
            border-top: 2px solid #dee2e6; 
            padding-top: 20px; 
            margin-top: 20px; 
        }
        .reward-reminder {
            color: #dc3545;
            font-weight: bold;
        }
        .demo-data-btn {
            margin-left: 10px;
        }
        .level-member { color: #6c757d; }
        .level-area { color: #198754; font-weight: bold; }
        .level-city { color: #0d6efd; font-weight: bold; }
        .green-points-warning {
            color: #856404;
            font-weight: bold;
            background-color: #fff3cd;
            padding: 2px 8px;
            border-radius: 4px;
            border: 1px solid #ffeaa7;
        }
        .success-message {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            min-width: 300px;
            max-width: 500px;
        }
        .card-header {
            background-color: #f8f9fa;
            font-weight: bold;
        }
        .nav-tabs .nav-link.active {
            background-color: #fff;
            border-bottom: 2px solid #0d6efd;
            color: #0d6efd;
            font-weight: bold;
        }
        .badge-custom {
            font-size: 0.8em;
            padding: 4px 8px;
        }
        .modal-lg {
            max-width: 1000px;
        }
        .form-control:readonly {
            background-color: #e9ecef;
            opacity: 1;
        }
        .statistics-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .statistics-number {
            font-size: 2.5rem;
            font-weight: bold;
        }
        .statistics-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        .daily-stats-table th {
            background-color: #e3f2fd;
        }
        .daily-total-row {
            background-color: #f8f9fa;
            font-weight: bold;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.85);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 99999;
            flex-direction: column;
            display: none;
        }
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 6px solid #f3f3f3;
            border-top: 6px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .loading-text {
            font-size: 1.2rem;
            color: #333;
            font-weight: 500;
        }
        .progress-container {
            width: 300px;
            margin-top: 15px;
            background-color: #e9ecef;
            border-radius: 5px;
            overflow: hidden;
        }
        .progress-bar {
            height: 20px;
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            width: 0%;
            transition: width 0.3s ease;
        }
        /* æœç´¢åŒºåŸŸæ ·å¼ */
        .search-area {
            background: #fff;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .search-title {
            margin-bottom: 15px;
            color: #333;
        }
        .search-results {
            margin-top: 20px;
        }
        .member-tree {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            background-color: #f8f9fa;
        }
        .tree-node {
            padding: 5px 10px;
            margin: 2px 0;
            background-color: white;
            border-radius: 3px;
            border-left: 3px solid #0d6efd;
        }
        .tree-node.level-1 { margin-left: 0px; border-left-color: #198754; }
        .tree-node.level-2 { margin-left: 20px; border-left-color: #0d6efd; }
        .tree-node.level-3 { margin-left: 40px; border-left-color: #6c757d; }
        .tree-node.level-4 { margin-left: 60px; border-left-color: #ffc107; }
        .tree-node.level-5 { margin-left: 80px; border-left-color: #dc3545; }
        .member-link {
            cursor: pointer;
            color: #0d6efd;
            text-decoration: underline;
        }
        .member-link:hover {
            color: #0b5ed7;
            text-decoration: none;
        }
        /* å¯¼å…¥è®¢å•å¥–åŠ±è®¡ç®—çŠ¶æ€ */
        .import-reward-status {
            margin-top: 15px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 5px;
            border-left: 4px solid #0d6efd;
        }
        .reward-calc-step {
            margin: 5px 0;
            padding: 5px;
            background-color: #e9ecef;
            border-radius: 3px;
        }
        .reward-calc-step.success {
            background-color: #d1e7dd;
            color: #0f5132;
            border-left: 3px solid #198754;
        }
        .reward-calc-step.error {
            background-color: #f8d7da;
            color: #842029;
            border-left: 3px solid #dc3545;
        }
        .reward-calc-step.processing {
            background-color: #cfe2ff;
            color: #084298;
            border-left: 3px solid #0d6efd;
        }
    </style>
</head>
<body>
    <!-- åŠ è½½é®ç½©å±‚ -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText">æ­£åœ¨å¤„ç†ï¼Œè¯·ç¨å€™...</div>
        <div class="progress-container">
            <div class="progress-bar" id="progressBar"></div>
        </div>
    </div>

    <!-- æˆåŠŸæç¤º -->
    <div id="successToast" class="toast success-message" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header bg-success text-white">
            <strong class="me-auto">âœ“ æ“ä½œæˆåŠŸ</strong>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body">
            <span id="successMessage"></span>
        </div>
    </div>

    <!-- é”™è¯¯æç¤º -->
    <div id="errorToast" class="toast success-message" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header bg-danger text-white">
            <strong class="me-auto">âœ— æ“ä½œå¤±è´¥</strong>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body">
            <span id="errorMessage"></span>
        </div>
    </div>

    <!-- åŸºå‡†æ—¶é—´æ§åˆ¶ -->
    <div class="time-control">
        <h5>ğŸ“… åŸºå‡†æ—¶é—´æ§åˆ¶</h5>
        <div class="d-flex align-items-center flex-wrap gap-2">
            <button id="minusDay" class="btn btn-outline-secondary">â—€ å‡å°‘ä¸€å¤©</button>
            <span id="baseTime" class="mx-3 fw-bold fs-5">2025-09-09</span>
            <button id="addDay" class="btn btn-outline-primary">å¢åŠ ä¸€å¤© â–¶</button>
            <button id="check16DayReward" class="btn btn-warning ms-3">ğŸ” æ£€æŸ¥16å¤©å¥–åŠ±</button>
            <button id="createDemoData" class="btn btn-info demo-data-btn">ğŸ“Š åˆ›å»ºæ¼”ç¤ºæ•°æ®</button>
        </div>
        <div id="greenPointsMonitor" class="mt-3 p-2 bg-warning bg-opacity-10 border-start border-warning border-3" style="display: none;">
            <div class="d-flex align-items-center">
                <span class="badge bg-warning text-dark me-2">âš ï¸ ç»¿ç§¯åˆ†ç›‘æ§</span>
                <span id="greenPointsAlert" class="fs-6"></span>
            </div>
        </div>
    </div>

    <!-- æ ‡ç­¾é¡µå¯¼èˆª -->
    <ul class="nav nav-tabs" id="myTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="member-tab" data-bs-toggle="tab" data-bs-target="#member" type="button" role="tab">ğŸ‘¥ ä¼šå‘˜ä¿¡æ¯è¡¨</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="order-tab" data-bs-toggle="tab" data-bs-target="#order" type="button" role="tab">ğŸ›’ è®¢å•è¡¨</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="reward-tab" data-bs-toggle="tab" data-bs-target="#reward" type="button" role="tab">ğŸ’° ç§¯åˆ†å¥–åŠ±è¡¨</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="statistics-tab" data-bs-toggle="tab" data-bs-target="#statistics" type="button" role="tab">ğŸ“Š ç»Ÿè®¡æŠ¥è¡¨</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="import-export-tab" data-bs-toggle="tab" data-bs-target="#import-export" type="button" role="tab">ğŸ“ å¯¼å…¥/å¯¼å‡º</button>
        </li>
    </ul>

    <!-- æ ‡ç­¾é¡µå†…å®¹ -->
    <div class="tab-content" id="myTabContent">
        <!-- ä¼šå‘˜ä¿¡æ¯æ ‡ç­¾é¡µ -->
        <div class="tab-pane fade show active" id="member" role="tabpanel" aria-labelledby="member-tab">
            <!-- æœç´¢åŒºåŸŸ -->
            <div class="search-area">
                <h5 class="search-title">ğŸ” ä¼šå‘˜æœç´¢ä¸ç­›é€‰</h5>
                <div class="row g-3">
                    <div class="col-md-3">
                        <label for="searchMemberId" class="form-label">æŒ‰IDæœç´¢</label>
                        <input type="number" class="form-control" id="searchMemberId" placeholder="è¾“å…¥ä¼šå‘˜ID">
                    </div>
                    <div class="col-md-3">
                        <label for="searchMemberName" class="form-label">æŒ‰å§“åæœç´¢</label>
                        <input type="text" class="form-control" id="searchMemberName" placeholder="è¾“å…¥å§“å">
                    </div>
                    <div class="col-md-3">
                        <label for="filterMemberLevel" class="form-label">æŒ‰çº§åˆ«ç­›é€‰</label>
                        <select class="form-select" id="filterMemberLevel">
                            <option value="">å…¨éƒ¨çº§åˆ«</option>
                            <option value="ä¼šå‘˜">ä¼šå‘˜</option>
                            <option value="åŒºä»£">åŒºä»£</option>
                            <option value="å¸‚ä»£">å¸‚ä»£</option>
                        </select>
                    </div>
                    <div class="col-md-3 d-flex align-items-end">
                        <button id="searchMemberBtn" class="btn btn-primary w-100 me-2">ğŸ” æœç´¢</button>
                        <button id="clearSearchBtn" class="btn btn-secondary w-100">ğŸ”„ æ¸…ç©º</button>
                    </div>
                </div>
                
                <!-- æœç´¢ç»“æœ/ä¼šå‘˜æ ‘å½¢ç»“æ„ -->
                <div id="searchResults" class="search-results" style="display: none;">
                    <h6>æœç´¢ç»“æœ / ä¼šå‘˜ç»“æ„</h6>
                    <div id="memberTree" class="member-tree"></div>
                </div>
            </div>

            <div class="card mb-4">
                <div class="card-header">â• æ·»åŠ ä¼šå‘˜</div>
                <div class="card-body">
                    <form id="addMemberForm">
                        <div class="row g-3">
                            <div class="col-md-2">
                                <label for="memberId" class="form-label">ä¼šå‘˜ID</label>
                                <input type="number" class="form-control" id="memberId" placeholder="è‡ªåŠ¨ç”Ÿæˆ">
                            </div>
                            <div class="col-md-2">
                                <label for="memberName" class="form-label">å§“å *</label>
                                <input type="text" class="form-control" id="memberName" required placeholder="è¯·è¾“å…¥å§“å">
                            </div>
                            <div class="col-md-2">
                                <label for="referrer" class="form-label">æ¨èäººID</label>
                                <input type="number" class="form-control" id="referrer" placeholder="æ— åˆ™ç•™ç©º">
                            </div>
                            <div class="col-md-2">
                                <label for="contactPerson" class="form-label">æ¥ç‚¹äººID</label>
                                <input type="number" class="form-control" id="contactPerson" placeholder="æ— åˆ™ç•™ç©º">
                            </div>
                            <div class="col-md-2">
                                <label for="memberLevel" class="form-label">åˆå§‹çº§åˆ«</label>
                                <select class="form-select" id="memberLevel">
                                    <option value="ä¼šå‘˜">ä¼šå‘˜</option>
                                    <option value="åŒºä»£" disabled>åŒºä»£ï¼ˆè‡ªåŠ¨å‡çº§ï¼‰</option>
                                    <option value="å¸‚ä»£" disabled>å¸‚ä»£ï¼ˆè‡ªåŠ¨å‡çº§ï¼‰</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label for="isReinvest" class="form-label">æ˜¯å¦å¤æŠ•</label>
                                <select class="form-select" id="isReinvest">
                                    <option value="false">å¦</option>
                                    <option value="true">æ˜¯</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="registerTime" class="form-label">æ³¨å†Œæ—¶é—´</label>
                                <input type="date" class="form-control" id="registerTime" value="2025-09-09">
                            </div>
                            <div class="col-md-12 mt-2">
                                <button type="submit" class="btn btn-success px-4">âœ… æ·»åŠ ä¼šå‘˜</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <div class="card">
                <div class="card-header">ğŸ“‹ ä¼šå‘˜ä¿¡æ¯åˆ—è¡¨</div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover table-bordered">
                            <thead class="table-light">
                                <tr>
                                    <th>ID</th>
                                    <th>å§“å</th>
                                    <th>æ¨èäºº</th>
                                    <th>æ¥ç‚¹äºº</th>
                                    <th>ç›´æ¨æ•°é‡</th>
                                    <th>çº§åˆ«</th>
                                    <th>å¤è´­æ¬¡æ•°</th>
                                    <th>å¤æŠ•</th>
                                    <th>ç´¯è®¡ä¸šç»©</th>
                                    <th>ç³»ç»Ÿå¥–åŠ±</th>
                                    <th>ç›´æ¨å¥–</th>
                                    <th>åŒºä»£å¥–</th>
                                    <th>å¹³çº§å¥–</th>
                                    <th>å¸‚ä»£å¥–</th>
                                    <th>ç»¿ç§¯åˆ†</th>
                                    <th>çº¢ç§¯åˆ†</th>
                                    <th>ç´¯è®¡æ”¶ç›Š</th>
                                    <th>æ³¨å†Œæ—¶é—´</th>
                                    <th>æ˜¯å¦ç©ºå·</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="memberTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- è®¢å•æ ‡ç­¾é¡µ -->
        <div class="tab-pane fade" id="order" role="tabpanel" aria-labelledby="order-tab">
            <div class="card mb-4">
                <div class="card-header">â• æ·»åŠ è®¢å•</div>
                <div class="card-body">
                    <form id="addOrderForm">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label for="orderMemberId" class="form-label">ä¼šå‘˜ID *</label>
                                <input type="number" class="form-control" id="orderMemberId" required placeholder="è¯·è¾“å…¥ä¼šå‘˜ID">
                            </div>
                            <div class="col-md-3">
                                <label for="orderMemberName" class="form-label">å§“å *</label>
                                <input type="text" class="form-control" id="orderMemberName" required placeholder="è¯·è¾“å…¥å§“å">
                            </div>
                            <div class="col-md-2">
                                <label for="orderAmount" class="form-label">ä¸‹å•é‡‘é¢</label>
                                <input type="number" class="form-control" id="orderAmount" value="1998" readonly>
                            </div>
                            <div class="col-md-2">
                                <label for="orderType" class="form-label">è®¢å•ç±»å‹</label>
                                <select class="form-select" id="orderType">
                                    <option value="æ™®é€šè®¢å•">æ™®é€šè®¢å•</option>
                                    <option value="å¤è´­è®¢å•">å¤è´­è®¢å•</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label for="orderTime" class="form-label">ä¸‹å•æ—¶é—´</label>
                                <input type="date" class="form-control" id="orderTime" value="2025-09-09">
                            </div>
                            <div class="col-md-12 mt-2">
                                <button type="submit" class="btn btn-success px-4">âœ… æ·»åŠ è®¢å•</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">ğŸ“‹ è®¢å•åˆ—è¡¨</div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover table-bordered">
                            <thead class="table-light">
                                <tr>
                                    <th>ID</th>
                                    <th>ä¼šå‘˜ID</th>
                                    <th>å§“å</th>
                                    <th>ä¸‹å•é‡‘é¢</th>
                                    <th>è®¢å•ç±»å‹</th>
                                    <th>è®¢å•ç¼–å·</th>
                                    <th>ä¸‹å•æ—¶é—´</th>
                                    <th>16å¤©å¥–åŠ±çŠ¶æ€</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="orderTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç§¯åˆ†å¥–åŠ±æ ‡ç­¾é¡µ -->
        <div class="tab-pane fade" id="reward" role="tabpanel" aria-labelledby="reward-tab">
            <div class="filter-area">
                <h5>ğŸ” ç§¯åˆ†å¥–åŠ±ç­›é€‰</h5>
                <div class="row g-3">
                    <div class="col-md-2">
                        <label for="filterRewardId" class="form-label">å¥–åŠ±ID</label>
                        <input type="number" class="form-control" id="filterRewardId" placeholder="è¯·è¾“å…¥ID">
                    </div>
                    <div class="col-md-2">
                        <label for="filterRewardName" class="form-label">ä¼šå‘˜å§“å</label>
                        <input type="text" class="form-control" id="filterRewardName" placeholder="è¯·è¾“å…¥å§“å">
                    </div>
                    <div class="col-md-2">
                        <label for="filterRewardType" class="form-label">å¥–åŠ±ç±»å‹</label>
                        <select class="form-select" id="filterRewardType">
                            <option value="">å…¨éƒ¨</option>
                            <option value="ç³»ç»Ÿå¥–åŠ±">ç³»ç»Ÿå¥–åŠ±</option>
                            <option value="ç›´æ¨å¥–">ç›´æ¨å¥–</option>
                            <option value="åŒºä»£å¥–">åŒºä»£å¥–</option>
                            <option value="å¹³çº§å¥–">å¹³çº§å¥–</option>
                            <option value="å¸‚ä»£å¥–">å¸‚ä»£å¥–</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="filterStartTime" class="form-label">å¼€å§‹æ—¶é—´</label>
                        <input type="date" class="form-control" id="filterStartTime">
                    </div>
                    <div class="col-md-2">
                        <label for="filterEndTime" class="form-label">ç»“æŸæ—¶é—´</label>
                        <input type="date" class="form-control" id="filterEndTime">
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button id="filterRewardBtn" class="btn btn-primary w-100">ğŸ” ç­›é€‰</button>
                    </div>
                </div>
            </div>

            <div class="card mb-4">
                <div class="card-header">â• æ·»åŠ ç§¯åˆ†å¥–åŠ±</div>
                <div class="card-body">
                    <form id="addRewardForm">
                        <div class="row g-3">
                            <div class="col-md-2">
                                <label for="rewardMemberId" class="form-label">ä¼šå‘˜ID *</label>
                                <input type="number" class="form-control" id="rewardMemberId" required placeholder="è¯·è¾“å…¥ä¼šå‘˜ID">
                            </div>
                            <div class="col-md-2">
                                <label for="rewardMemberName" class="form-label">å§“å *</label>
                                <input type="text" class="form-control" id="rewardMemberName" required placeholder="è¯·è¾“å…¥å§“å">
                            </div>
                            <div class="col-md-2">
                                <label for="rewardType" class="form-label">å¥–åŠ±ç±»å‹ *</label>
                                <select class="form-select" id="rewardType" required>
                                    <option value="">è¯·é€‰æ‹©</option>
                                    <option value="ç³»ç»Ÿå¥–åŠ±">ç³»ç»Ÿå¥–åŠ±</option>
                                    <option value="ç›´æ¨å¥–">ç›´æ¨å¥–</option>
                                    <option value="åŒºä»£å¥–">åŒºä»£å¥–</option>
                                    <option value="å¹³çº§å¥–">å¹³çº§å¥–</option>
                                    <option value="å¸‚ä»£å¥–">å¸‚ä»£å¥–</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label for="rewardAmount" class="form-label">å¥–åŠ±æ•°é‡ *</label>
                                <input type="number" class="form-control" id="rewardAmount" required placeholder="è¯·è¾“å…¥é‡‘é¢" step="0.01">
                            </div>
                            <div class="col-md-2">
                                <label for="rewardTime" class="form-label">å¥–åŠ±æ—¶é—´</label>
                                <input type="date" class="form-control" id="rewardTime" value="2025-09-09">
                            </div>
                            <div class="col-md-2">
                                <label for="targetMemberId" class="form-label">å¯¹æ–¹ID</label>
                                <input type="number" class="form-control" id="targetMemberId" placeholder="æ— åˆ™ç•™ç©º">
                            </div>
                            <div class="col-md-12 mt-2">
                                <button type="submit" class="btn btn-success px-4">âœ… æ·»åŠ å¥–åŠ±</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <div class="card">
                <div class="card-header">ğŸ“‹ ç§¯åˆ†å¥–åŠ±åˆ—è¡¨</div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover table-bordered">
                            <thead class="table-light">
                                <tr>
                                    <th>ID</th>
                                    <th>ä¼šå‘˜ID</th>
                                    <th>å§“å</th>
                                    <th>å¥–åŠ±ç±»å‹</th>
                                    <th>å¥–åŠ±æ•°é‡</th>
                                    <th>ç»¿ç§¯åˆ†(75%)</th>
                                    <th>çº¢ç§¯åˆ†(25%)</th>
                                    <th>å¥–åŠ±æ—¶é—´</th>
                                    <th>å¯¹æ–¹ID</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="rewardTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç»Ÿè®¡æŠ¥è¡¨æ ‡ç­¾é¡µ -->
        <div class="tab-pane fade" id="statistics" role="tabpanel" aria-labelledby="statistics-tab">
            <div class="filter-area">
                <h5>ğŸ“Š ç»Ÿè®¡æŠ¥è¡¨ç­›é€‰</h5>
                <div class="row g-3">
                    <div class="col-md-3">
                        <label for="statStartDate" class="form-label">å¼€å§‹æ—¥æœŸ</label>
                        <input type="date" class="form-control" id="statStartDate">
                    </div>
                    <div class="col-md-3">
                        <label for="statEndDate" class="form-label">ç»“æŸæ—¥æœŸ</label>
                        <input type="date" class="form-control" id="statEndDate">
                    </div>
                    <div class="col-md-3">
                        <label for="statGroupBy" class="form-label">åˆ†ç»„æ–¹å¼</label>
                        <select class="form-select" id="statGroupBy">
                            <option value="day">æŒ‰å¤©ç»Ÿè®¡</option>
                            <option value="week">æŒ‰å‘¨ç»Ÿè®¡</option>
                            <option value="month">æŒ‰æœˆç»Ÿè®¡</option>
                        </select>
                    </div>
                    <div class="col-md-3 d-flex align-items-end">
                        <button id="statisticsBtn" class="btn btn-primary w-100">ğŸ“ˆ ç”Ÿæˆç»Ÿè®¡</button>
                    </div>
                </div>
            </div>

            <!-- ç»Ÿè®¡æ¦‚è§ˆå¡ç‰‡ -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="statistics-card bg-primary">
                        <div class="statistics-number" id="totalOrders">0</div>
                        <div class="statistics-label">æ€»è®¢å•æ•°</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="statistics-card bg-success">
                        <div class="statistics-number" id="totalRevenue">0</div>
                        <div class="statistics-label">æ€»é”€å”®é¢(å…ƒ)</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="statistics-card bg-warning">
                        <div class="statistics-number" id="totalRewards">0</div>
                        <div class="statistics-label">æ€»å¥–åŠ±é‡‘é¢(å…ƒ)</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="statistics-card bg-info">
                        <div class="statistics-number" id="totalMembers">0</div>
                        <div class="statistics-label">æ€»ä¼šå‘˜æ•°</div>
                    </div>
                </div>
            </div>

            <!-- å¥–åŠ±ç±»å‹åˆ†å¸ƒ -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">ğŸ¯ å¥–åŠ±ç±»å‹åˆ†å¸ƒ</div>
                        <div class="card-body">
                            <table class="table table-bordered">
                                <thead>
                                    <tr>
                                        <th>å¥–åŠ±ç±»å‹</th>
                                        <th>æ•°é‡</th>
                                        <th>é‡‘é¢(å…ƒ)</th>
                                        <th>å æ¯”</th>
                                    </tr>
                                </thead>
                                <tbody id="rewardTypeStats"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">ğŸ“… æ¯æ—¥ç»Ÿè®¡</div>
                        <div class="card-body">
                            <table class="table table-bordered daily-stats-table">
                                <thead>
                                    <tr>
                                        <th>æ—¥æœŸ</th>
                                        <th>è®¢å•æ•°</th>
                                        <th>é”€å”®é¢</th>
                                        <th>å¥–åŠ±æ•°</th>
                                        <th>å¥–åŠ±é‡‘é¢</th>
                                    </tr>
                                </thead>
                                <tbody id="dailyStatsTable"></tbody>
                                <tfoot>
                                    <tr class="daily-total-row">
                                        <td>æ€»è®¡</td>
                                        <td id="dailyTotalOrders">0</td>
                                        <td id="dailyTotalRevenue">0</td>
                                        <td id="dailyTotalRewards">0</td>
                                        <td id="dailyTotalRewardAmount">0</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- è¯¦ç»†ç»Ÿè®¡æ•°æ®è¡¨ -->
            <div class="card mb-4">
                <div class="card-header">ğŸ“ˆ è¯¦ç»†ç»Ÿè®¡è¡¨</div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-bordered">
                            <thead class="table-light">
                                <tr>
                                    <th rowspan="2">æ—¥æœŸ</th>
                                    <th colspan="5" class="text-center">è®¢å•ç»Ÿè®¡</th>
                                    <th colspan="6" class="text-center">å¥–åŠ±ç»Ÿè®¡</th>
                                    <th colspan="2" class="text-center">ç§¯åˆ†ç»Ÿè®¡</th>
                                </tr>
                                <tr>
                                    <th>æ™®é€šè®¢å•</th>
                                    <th>å¤è´­è®¢å•</th>
                                    <th>æ€»è®¢å•æ•°</th>
                                    <th>æ€»é‡‘é¢</th>
                                    <th>16å¤©å¥–åŠ±</th>
                                    <th>ç³»ç»Ÿå¥–åŠ±</th>
                                    <th>ç›´æ¨å¥–</th>
                                    <th>åŒºä»£å¥–</th>
                                    <th>å¹³çº§å¥–</th>
                                    <th>å¸‚ä»£å¥–</th>
                                    <th>æ€»å¥–åŠ±</th>
                                    <th>ç»¿ç§¯åˆ†</th>
                                    <th>çº¢ç§¯åˆ†</th>
                                </tr>
                            </thead>
                            <tbody id="detailedStatsTable"></tbody>
                            <tfoot>
                                <tr class="table-warning">
                                    <td><strong>æ€»è®¡</strong></td>
                                    <td id="totalNormalOrders">0</td>
                                    <td id="totalRepurchaseOrders">0</td>
                                    <td id="totalAllOrders">0</td>
                                    <td id="totalAllRevenue">0</td>
                                    <td id="total16DayRewards">0</td>
                                    <td id="totalSystemRewards">0</td>
                                    <td id="totalDirectRewards">0</td>
                                    <td id="totalAreaRewards">0</td>
                                    <td id="totalPeerRewards">0</td>
                                    <td id="totalCityRewards">0</td>
                                    <td id="totalAllRewards">0</td>
                                    <td id="totalGreenPoints">0</td>
                                    <td id="totalRedPoints">0</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>

            <!-- ä¼šå‘˜çº§åˆ«ç»Ÿè®¡ -->
            <div class="row">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">ğŸ‘¥ ä¼šå‘˜çº§åˆ«åˆ†å¸ƒ</div>
                        <div class="card-body">
                            <table class="table table-bordered">
                                <thead>
                                    <tr>
                                        <th>ä¼šå‘˜çº§åˆ«</th>
                                        <th>äººæ•°</th>
                                        <th>å æ¯”</th>
                                        <th>å¹³å‡ä¸šç»©</th>
                                    </tr>
                                </thead>
                                <tbody id="memberLevelStats"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">ğŸ’° æ”¶ç›Šæ’è¡Œæ¦œï¼ˆå‰10ï¼‰</div>
                        <div class="card-body">
                            <table class="table table-bordered">
                                <thead>
                                    <tr>
                                        <th>æ’å</th>
                                        <th>ä¼šå‘˜ID</th>
                                        <th>å§“å</th>
                                        <th>çº§åˆ«</th>
                                        <th>æ€»æ”¶ç›Š(å…ƒ)</th>
                                    </tr>
                                </thead>
                                <tbody id="incomeRankingTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- å¯¼å…¥/å¯¼å‡ºæ ‡ç­¾é¡µ -->
        <div class="tab-pane fade" id="import-export" role="tabpanel" aria-labelledby="import-export-tab">
            <div class="card">
                <div class="card-header">ğŸ“ æ•°æ®å¯¼å…¥/å¯¼å‡º</div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-4">
                            <h5>ğŸ“¤ æ•°æ®å¯¼å‡º</h5>
                            <div class="d-flex flex-wrap gap-2">
                                <button id="exportMemberBtn" class="btn btn-primary">å¯¼å‡ºä¼šå‘˜ä¿¡æ¯è¡¨</button>
                                <button id="exportOrderBtn" class="btn btn-primary">å¯¼å‡ºè®¢å•è¡¨</button>
                                <button id="exportRewardBtn" class="btn btn-primary">å¯¼å‡ºç§¯åˆ†å¥–åŠ±è¡¨</button>
                                <button id="exportStatisticsBtn" class="btn btn-info">å¯¼å‡ºç»Ÿè®¡æŠ¥è¡¨</button>
                                <button id="exportAllBtn" class="btn btn-success">å¯¼å‡ºæ‰€æœ‰æ•°æ®</button>
                            </div>
                        </div>
                        
                        <div class="col-md-6 mb-4">
                            <h5>ğŸ“¥ æ•°æ®å¯¼å…¥</h5>
                            <div class="mb-3">
                                <label for="importMemberFile" class="form-label">å¯¼å…¥ä¼šå‘˜ä¿¡æ¯è¡¨ (CSV)</label>
                                <input type="file" class="form-control" id="importMemberFile" accept=".csv">
                                <button id="importMemberBtn" class="btn btn-success mt-2">ç¡®è®¤å¯¼å…¥</button>
                            </div>
                            <div class="mb-3">
                                <label for="importOrderFile" class="form-label">å¯¼å…¥è®¢å•è¡¨ (CSV)</label>
                                <input type="file" class="form-control" id="importOrderFile" accept=".csv">
                                <button id="importOrderBtn" class="btn btn-success mt-2">ç¡®è®¤å¯¼å…¥</button>
                            </div>
                            <div class="mb-3">
                                <label for="importRewardFile" class="form-label">å¯¼å…¥ç§¯åˆ†å¥–åŠ±è¡¨ (CSV)</label>
                                <input type="file" class="form-control" id="importRewardFile" accept=".csv">
                                <button id="importRewardBtn" class="btn btn-success mt-2">ç¡®è®¤å¯¼å…¥</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="clear-data-area">
                        <h5 class="text-danger">âš ï¸ æ•°æ®æ¸…ç©º</h5>
                        <p class="text-danger">æ³¨æ„ï¼šæ¸…ç©ºæ•°æ®åä¸å¯æ¢å¤ï¼Œè¯·è°¨æ…æ“ä½œï¼</p>
                        <div class="d-flex flex-wrap gap-2">
                            <button id="clearMemberBtn" class="btn btn-danger">æ¸…ç©ºä¼šå‘˜ä¿¡æ¯è¡¨</button>
                            <button id="clearOrderBtn" class="btn btn-danger">æ¸…ç©ºè®¢å•è¡¨</button>
                            <button id="clearRewardBtn" class="btn btn-danger">æ¸…ç©ºç§¯åˆ†å¥–åŠ±è¡¨</button>
                            <button id="clearAllBtn" class="btn btn-danger">æ¸…ç©ºæ‰€æœ‰è¡¨æ•°æ®</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ç¼–è¾‘ä¼šå‘˜æ¨¡æ€æ¡† -->
    <div class="modal fade" id="editMemberModal" tabindex="-1" aria-labelledby="editMemberModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editMemberModalLabel">âœï¸ ç¼–è¾‘ä¼šå‘˜ä¿¡æ¯</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editMemberForm">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label for="editMemberId" class="form-label">ä¼šå‘˜ID</label>
                                <input type="text" class="form-control" id="editMemberId" readonly>
                            </div>
                            <div class="col-md-3">
                                <label for="editMemberName" class="form-label">å§“å *</label>
                                <input type="text" class="form-control" id="editMemberName" required>
                            </div>
                            <div class="col-md-3">
                                <label for="editReferrer" class="form-label">æ¨èäººID</label>
                                <input type="number" class="form-control" id="editReferrer">
                            </div>
                            <div class="col-md-3">
                                <label for="editContactPerson" class="form-label">æ¥ç‚¹äººID</label>
                                <input type="number" class="form-control" id="editContactPerson">
                            </div>
                            <div class="col-md-2">
                                <label for="editDirectPush" class="form-label">ç›´æ¨æ•°é‡</label>
                                <input type="number" class="form-control" id="editDirectPush" readonly>
                            </div>
                            <div class="col-md-2">
                                <label for="editMemberLevel" class="form-label">çº§åˆ«</label>
                                <select class="form-select" id="editMemberLevel">
                                    <option value="ä¼šå‘˜">ä¼šå‘˜</option>
                                    <option value="åŒºä»£">åŒºä»£</option>
                                    <option value="å¸‚ä»£">å¸‚ä»£</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label for="editIsReinvest" class="form-label">æ˜¯å¦å¤æŠ•</label>
                                <select class="form-select" id="editIsReinvest">
                                    <option value="false">å¦</option>
                                    <option value="true">æ˜¯</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label for="editRepurchaseTimes" class="form-label">å¤è´­æ¬¡æ•°</label>
                                <input type="number" class="form-control" id="editRepurchaseTimes" min="0">
                            </div>
                            <div class="col-md-2">
                                <label for="editOrderCount" class="form-label">è®¢å•æ•°é‡</label>
                                <input type="number" class="form-control" id="editOrderCount" readonly>
                            </div>
                            <div class="col-md-2">
                                <label for="editTotalPerformance" class="form-label">ç´¯è®¡ä¸šç»©</label>
                                <input type="number" class="form-control" id="editTotalPerformance" readonly>
                            </div>
                            <div class="col-md-2">
                                <label for="editSystemReward" class="form-label">ç³»ç»Ÿå¥–åŠ±</label>
                                <input type="number" step="0.01" class="form-control" id="editSystemReward" min="0">
                            </div>
                            <div class="col-md-2">
                                <label for="editDirectReward" class="form-label">ç›´æ¨å¥–</label>
                                <input type="number" step="0.01" class="form-control" id="editDirectReward" min="0">
                            </div>
                            <div class="col-md-2">
                                <label for="editAreaReward" class="form-label">åŒºä»£å¥–</label>
                                <input type="number" step="0.01" class="form-control" id="editAreaReward" min="0">
                            </div>
                            <div class="col-md-2">
                                <label for="editPeerReward" class="form-label">å¹³çº§å¥–</label>
                                <input type="number" step="0.01" class="form-control" id="editPeerReward" min="0">
                            </div>
                            <div class="col-md-2">
                                <label for="editCityReward" class="form-label">å¸‚ä»£å¥–</label>
                                <input type="number" step="0.01" class="form-control" id="editCityReward" min="0">
                            </div>
                            <div class="col-md-2">
                                <label for="editGreenPoints" class="form-label">ç»¿ç§¯åˆ†</label>
                                <input type="number" step="0.01" class="form-control" id="editGreenPoints" min="0">
                            </div>
                            <div class="col-md-2">
                                <label for="editRedPoints" class="form-label">çº¢ç§¯åˆ†</label>
                                <input type="number" step="0.01" class="form-control" id="editRedPoints" min="0">
                            </div>
                            <div class="col-md-2">
                                <label for="editTotalIncome" class="form-label">ç´¯è®¡æ”¶ç›Š</label>
                                <input type="number" step="0.01" class="form-control" id="editTotalIncome" readonly>
                            </div>
                            <div class="col-md-2">
                                <label for="editIsEmptyAccount" class="form-label">æ˜¯å¦ç©ºå·</label>
                                <select class="form-select" id="editIsEmptyAccount">
                                    <option value="false">å¦</option>
                                    <option value="true">æ˜¯</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label for="editRegisterTime" class="form-label">æ³¨å†Œæ—¶é—´</label>
                                <input type="date" class="form-control" id="editRegisterTime">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" id="saveMemberEdit">ä¿å­˜ä¿®æ”¹</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ç¼–è¾‘è®¢å•æ¨¡æ€æ¡† -->
    <div class="modal fade" id="editOrderModal" tabindex="-1" aria-labelledby="editOrderModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editOrderModalLabel">âœï¸ ç¼–è¾‘è®¢å•ä¿¡æ¯</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editOrderForm">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="editOrderId" class="form-label">è®¢å•ID</label>
                                <input type="text" class="form-control" id="editOrderId" readonly>
                            </div>
                            <div class="col-md-6">
                                <label for="editOrderMemberId" class="form-label">ä¼šå‘˜ID *</label>
                                <input type="number" class="form-control" id="editOrderMemberId" required>
                            </div>
                            <div class="col-md-6">
                                <label for="editOrderMemberName" class="form-label">å§“å *</label>
                                <input type="text" class="form-control" id="editOrderMemberName" required>
                            </div>
                            <div class="col-md-6">
                                <label for="editOrderAmount" class="form-label">ä¸‹å•é‡‘é¢</label>
                                <input type="number" class="form-control" id="editOrderAmount" readonly>
                            </div>
                            <div class="col-md-6">
                                <label for="editOrderType" class="form-label">è®¢å•ç±»å‹</label>
                                <select class="form-select" id="editOrderType">
                                    <option value="æ™®é€šè®¢å•">æ™®é€šè®¢å•</option>
                                    <option value="å¤è´­è®¢å•">å¤è´­è®¢å•</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="editOrderTime" class="form-label">ä¸‹å•æ—¶é—´</label>
                                <input type="date" class="form-control" id="editOrderTime">
                            </div>
                            <div class="col-md-6">
                                <label for="edit16DayRewardStatus" class="form-label">16å¤©å¥–åŠ±çŠ¶æ€</label>
                                <select class="form-select" id="edit16DayRewardStatus">
                                    <option value="æœªåˆ°æ—¶é—´">æœªåˆ°æ—¶é—´</option>
                                    <option value="å·²å‘æ”¾">å·²å‘æ”¾</option>
                                    <option value="æ— ">æ— </option>
                                </select>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" id="saveOrderEdit">ä¿å­˜ä¿®æ”¹</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ç¼–è¾‘å¥–åŠ±æ¨¡æ€æ¡† -->
    <div class="modal fade" id="editRewardModal" tabindex="-1" aria-labelledby="editRewardModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editRewardModalLabel">âœï¸ ç¼–è¾‘ç§¯åˆ†å¥–åŠ±</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editRewardForm">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="editRewardId" class="form-label">å¥–åŠ±ID</label>
                                <input type="text" class="form-control" id="editRewardId" readonly>
                            </div>
                            <div class="col-md-6">
                                <label for="editRewardMemberId" class="form-label">ä¼šå‘˜ID *</label>
                                <input type="number" class="form-control" id="editRewardMemberId" required>
                            </div>
                            <div class="col-md-6">
                                <label for="editRewardMemberName" class="form-label">å§“å *</label>
                                <input type="text" class="form-control" id="editRewardMemberName" required>
                            </div>
                            <div class="col-md-6">
                                <label for="editRewardType" class="form-label">å¥–åŠ±ç±»å‹ *</label>
                                <select class="form-select" id="editRewardType" required>
                                    <option value="">è¯·é€‰æ‹©</option>
                                    <option value="ç³»ç»Ÿå¥–åŠ±">ç³»ç»Ÿå¥–åŠ±</option>
                                    <option value="ç›´æ¨å¥–">ç›´æ¨å¥–</option>
                                    <option value="åŒºä»£å¥–">åŒºä»£å¥–</option>
                                    <option value="å¹³çº§å¥–">å¹³çº§å¥–</option>
                                    <option value="å¸‚ä»£å¥–">å¸‚ä»£å¥–</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="editRewardAmount" class="form-label">å¥–åŠ±æ•°é‡ *</label>
                                <input type="number" step="0.01" class="form-control" id="editRewardAmount" required>
                            </div>
                            <div class="col-md-6">
                                <label for="editRewardTime" class="form-label">å¥–åŠ±æ—¶é—´</label>
                                <input type="date" class="form-control" id="editRewardTime">
                            </div>
                            <div class="col-md-6">
                                <label for="editTargetMemberId" class="form-label">å¯¹æ–¹ID</label>
                                <input type="number" class="form-control" id="editTargetMemberId">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" id="saveRewardEdit">ä¿å­˜ä¿®æ”¹</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        $(document).ready(function() {
            // åˆå§‹åŒ–æœ¬åœ°å­˜å‚¨
            if (!localStorage.getItem('members')) localStorage.setItem('members', JSON.stringify([]));
            if (!localStorage.getItem('orders')) localStorage.setItem('orders', JSON.stringify([]));
            if (!localStorage.getItem('rewards')) localStorage.setItem('rewards', JSON.stringify([]));
            
            // ç³»ç»Ÿå¸¸é‡
            const ORDER_PRICE = 1998;
            const DAY16_REWARD = 200;
            const AREA_AGENT_DAILY_CAP = 1000;
            const AUTO_REPURCHASE_THRESHOLD = 6000;
            
            let baseTime = new Date($('#baseTime').text());
            
            // æ€§èƒ½ä¼˜åŒ–ï¼šç¼“å­˜æœºåˆ¶
            let teamOrdersCache = {};
            let upperAgentsCache = {};
            let teamHierarchyCache = {};
            
            // æ˜¾ç¤ºæ¶ˆæ¯å‡½æ•°
            function showSuccessMessage(message) {
                $('#successMessage').text(message);
                const toast = new bootstrap.Toast(document.getElementById('successToast'));
                toast.show();
            }
            
            function showErrorMessage(message) {
                $('#errorMessage').text(message);
                const toast = new bootstrap.Toast(document.getElementById('errorToast'));
                toast.show();
            }
            
            // åŠ è½½åŠ¨ç”»æ§åˆ¶
            function showLoading(text = 'æ­£åœ¨å¤„ç†ï¼Œè¯·ç¨å€™...') {
                $('#loadingText').text(text);
                $('#loadingOverlay').show();
            }
            
            function updateLoading(progress, text) {
                if (progress !== undefined) {
                    $('#progressBar').css('width', progress + '%');
                }
                if (text) {
                    $('#loadingText').text(text);
                }
            }
            
            function hideLoading() {
                $('#loadingOverlay').hide();
                $('#progressBar').css('width', '0%');
            }
            
            // æ¸…ç©ºç¼“å­˜
            function clearCache() {
                teamOrdersCache = {};
                upperAgentsCache = {};
                teamHierarchyCache = {};
            }
            
            // æ—¥æœŸæ ¼å¼åŒ–
            function formatDate(date) {
                if (!(date instanceof Date)) date = new Date(date);
                let year = date.getFullYear();
                let month = (date.getMonth() + 1).toString().padStart(2, '0');
                let day = date.getDate().toString().padStart(2, '0');
                return `${year}-${month}-${day}`;
            }
            
            function formatDateForOrderNo(date) {
                let year = date.getFullYear();
                let month = (date.getMonth() + 1).toString().padStart(2, '0');
                let day = date.getDate().toString().padStart(2, '0');
                return `${year}${month}${day}`;
            }
            
            // æ›´æ–°åŸºå‡†æ—¶é—´æ˜¾ç¤º
            function updateBaseTimeDisplay() {
                $('#baseTime').text(formatDate(baseTime));
                $('#registerTime').val(formatDate(baseTime));
                $('#orderTime').val(formatDate(baseTime));
                $('#rewardTime').val(formatDate(baseTime));
            }
            
            // è·å–æœ€å¤§ID
            function getMaxId(arr) {
                if (!arr || arr.length === 0) return 0;
                return Math.max(...arr.map(item => item.id || 0));
            }
            
            // é‡æ–°è®¡ç®—ç›´æ¨æ•°é‡ï¼ˆä¼˜åŒ–ç‰ˆï¼‰
            function recalculateDirectPush() {
                let members = JSON.parse(localStorage.getItem('members')) || [];
                
                // é‡ç½®ç›´æ¨æ•°é‡
                members.forEach(member => {
                    member.directPush = 0;
                });
                
                // ä½¿ç”¨Mapæé«˜æ€§èƒ½
                let memberMap = new Map();
                members.forEach(member => {
                    memberMap.set(member.id, member);
                });
                
                // è®¡ç®—ç›´æ¨æ•°é‡
                members.forEach(member => {
                    if (member.referrer) {
                        let referrer = memberMap.get(member.referrer);
                        if (referrer) {
                            referrer.directPush = (referrer.directPush || 0) + 1;
                        }
                    }
                });
                
                localStorage.setItem('members', JSON.stringify(members));
                clearCache(); // æ¸…ç©ºç¼“å­˜
                return members;
            }
            
            // æ£€æŸ¥åŒºä»£èµ„æ ¼ï¼ˆä¼˜åŒ–ç‰ˆï¼‰
            function checkAreaAgentQualification(memberId) {
                let members = JSON.parse(localStorage.getItem('members')) || [];
                let member = members.find(m => m.id === memberId);
                
                if (!member) return false;
                if (member.isEmptyAccount) return false;
                
                let directMembers = members.filter(m => m.referrer === memberId && !m.isEmptyAccount);
                if (directMembers.length < 3) return false;
                
                // å–å‰3ä¸ªç›´å±ä¼šå‘˜
                let top3DirectMembers = directMembers.slice(0, 3);
                let totalOrdersFrom3Markets = 0;
                
                // ä½¿ç”¨ç¼“å­˜è·å–å›¢é˜Ÿè®¢å•
                top3DirectMembers.forEach(directMember => {
                    let teamOrders = getTeamOrdersOptimized(directMember.id);
                    totalOrdersFrom3Markets += teamOrders.length;
                });
                
                return totalOrdersFrom3Markets >= 5;
            }
            
            // æ£€æŸ¥å¸‚ä»£èµ„æ ¼ï¼ˆä¼˜åŒ–ç‰ˆï¼‰
            function checkCityAgentQualification(memberId) {
                let members = JSON.parse(localStorage.getItem('members')) || [];
                let member = members.find(m => m.id === memberId);
                
                if (!member) return false;
                if (member.isEmptyAccount) return false;
                if (member.level !== 'åŒºä»£') return false;
                
                let directMembers = members.filter(m => m.referrer === memberId && !m.isEmptyAccount);
                let areaAgentsInDirect = directMembers.filter(m => m.level === 'åŒºä»£');
                if (areaAgentsInDirect.length < 3) return false;
                
                let teamPerformance = getTeamOrdersOptimized(memberId).length * ORDER_PRICE;
                return teamPerformance >= 100000;
            }
            
            // è·å–å›¢é˜Ÿè®¢å•ï¼ˆä¼˜åŒ–ç‰ˆ - ä½¿ç”¨è¿­ä»£ä»£æ›¿é€’å½’ï¼‰
            function getTeamOrdersOptimized(memberId) {
                // æ£€æŸ¥ç¼“å­˜
                if (teamOrdersCache[memberId]) {
                    return teamOrdersCache[memberId];
                }
                
                let members = JSON.parse(localStorage.getItem('members')) || [];
                let orders = JSON.parse(localStorage.getItem('orders')) || [];
                
                // ä½¿ç”¨è¿­ä»£ç®—æ³•ä»£æ›¿é€’å½’
                let teamMemberIds = new Set([memberId]);
                let queue = [memberId];
                
                while (queue.length > 0) {
                    let currentId = queue.shift();
                    // ä½¿ç”¨filteræŸ¥æ‰¾ç›´å±ä¼šå‘˜ï¼ˆæ¯”findæ€§èƒ½æ›´å¥½ï¼‰
                    for (let i = 0; i < members.length; i++) {
                        let m = members[i];
                        if (m.referrer === currentId && !m.isEmptyAccount && !teamMemberIds.has(m.id)) {
                            teamMemberIds.add(m.id);
                            queue.push(m.id);
                        }
                    }
                }
                
                // è¿‡æ»¤è®¢å•
                let teamOrders = orders.filter(o => teamMemberIds.has(o.memberId));
                
                // ç¼“å­˜ç»“æœ
                teamOrdersCache[memberId] = teamOrders;
                return teamOrders;
            }
            
            // è®¡ç®—ç´¯è®¡ä¸šç»©
            function calculateTotalPerformance(memberId) {
                let teamOrders = getTeamOrdersOptimized(memberId);
                return teamOrders.length * ORDER_PRICE;
            }
            
            // åŒæ­¥å¥–åŠ±åˆ°ä¼šå‘˜ï¼ˆä¼˜åŒ–ç‰ˆï¼‰
            function syncRewardsToMembers() {
                let members = JSON.parse(localStorage.getItem('members')) || [];
                let rewards = JSON.parse(localStorage.getItem('rewards')) || [];
                
                // åˆ›å»ºä¼šå‘˜æ˜ å°„ä»¥å¿«é€ŸæŸ¥æ‰¾
                let memberMap = new Map();
                members.forEach(member => {
                    // åˆå§‹åŒ–å­—æ®µ
                    member.systemReward = 0;
                    member.directReward = 0;
                    member.areaReward = 0;
                    member.peerReward = 0;
                    member.cityReward = 0;
                    member.greenPoints = 0;
                    member.redPoints = 0;
                    member.totalIncome = 0;
                    memberMap.set(member.id, member);
                });
                
                // ç´¯åŠ å¥–åŠ±
                rewards.forEach(reward => {
                    let member = memberMap.get(reward.memberId);
                    if (member) {
                        switch (reward.type) {
                            case 'ç³»ç»Ÿå¥–åŠ±':
                                member.systemReward += reward.amount;
                                break;
                            case 'ç›´æ¨å¥–':
                                member.directReward += reward.amount;
                                break;
                            case 'åŒºä»£å¥–':
                                member.areaReward += reward.amount;
                                break;
                            case 'å¹³çº§å¥–':
                                member.peerReward += reward.amount;
                                break;
                            case 'å¸‚ä»£å¥–':
                                member.cityReward += reward.amount;
                                break;
                        }
                        
                        member.greenPoints += (reward.greenPoints || 0);
                        member.redPoints += (reward.redPoints || 0);
                        member.totalIncome += reward.amount;
                    }
                });
                
                // æ›´æ–°è®¢å•æ•°é‡
                let orders = JSON.parse(localStorage.getItem('orders')) || [];
                members.forEach(member => {
                    // ä½¿ç”¨filterè®¡æ•°
                    member.orderCount = orders.filter(o => o.memberId === member.id).length;
                    member.totalPerformance = calculateTotalPerformance(member.id);
                });
                
                localStorage.setItem('members', JSON.stringify(members));
                return members;
            }
            
            // è‡ªåŠ¨å‡çº§ä¼šå‘˜
            function autoUpgradeAllMembers() {
                let members = JSON.parse(localStorage.getItem('members')) || [];
                let upgraded = false;
                
                members.forEach(member => {
                    if (member.isEmptyAccount) return;
                    
                    let oldLevel = member.level;
                    
                    if (checkCityAgentQualification(member.id) && member.level !== 'å¸‚ä»£') {
                        member.level = 'å¸‚ä»£';
                        upgraded = true;
                    } else if (checkAreaAgentQualification(member.id) && member.level !== 'åŒºä»£' && member.level !== 'å¸‚ä»£') {
                        member.level = 'åŒºä»£';
                        upgraded = true;
                    }
                });
                
                if (upgraded) {
                    localStorage.setItem('members', JSON.stringify(members));
                    clearCache(); // æ¸…ç©ºç¼“å­˜
                }
                
                return members;
            }
            
            // è®¡ç®—ç›´æ¨å¥–
            function calculateDirectReward() {
                return ORDER_PRICE * 0.05;
            }
            
            // è®¡ç®—åŒºä»£å¥–ï¼ˆä¼˜åŒ–ç‰ˆï¼Œè€ƒè™‘æ¯æ—¥å°é¡¶1000å…ƒï¼ŒåŒ…æ‹¬ç›´æ¨å¥–ã€å¹³çº§å¥–ã€åŒºä»£å¥–ï¼‰
            function calculateAreaReward(memberId, rewardDate) {
                let members = JSON.parse(localStorage.getItem('members')) || [];
                let rewards = JSON.parse(localStorage.getItem('rewards')) || [];
                let member = members.find(m => m.id === memberId);
                
                if (!member || member.level !== 'åŒºä»£' || member.isEmptyAccount) return 0;
                
                // è®¡ç®—è¯¥åŒºä»£å½“æ—¥å·²è·å¾—çš„æ‰€æœ‰å¥–åŠ±ï¼ˆç›´æ¨å¥–+å¹³çº§å¥–+åŒºä»£å¥–ï¼‰æ€»å’Œ
                let todayTotal = rewards
                    .filter(r => r.memberId === memberId && 
                                r.rewardTime === rewardDate &&
                                ['ç›´æ¨å¥–', 'å¹³çº§å¥–', 'åŒºä»£å¥–'].includes(r.type))
                    .reduce((sum, r) => sum + r.amount, 0);
                
                // åŒºä»£å¥–é‡‘é¢ï¼ˆ0.5%çš„è®¢å•é‡‘é¢ï¼‰
                let areaRewardAmount = ORDER_PRICE * 0.005;
                
                // è®¡ç®—å‰©ä½™é¢åº¦
                let remaining = AREA_AGENT_DAILY_CAP - todayTotal;
                
                return remaining > 0 ? Math.min(areaRewardAmount, remaining) : 0;
            }
            
            // è®¡ç®—å¸‚ä»£å¥–
            function calculateCityReward() {
                return ORDER_PRICE * 0.03;
            }
            
            // åˆ†é…ç§¯åˆ†
            function allocatePoints(amount) {
                return {
                    green: amount * 0.75,
                    red: amount * 0.25
                };
            }
            
            // æ·»åŠ å¥–åŠ±è®°å½•ï¼ˆä¼˜åŒ–ç‰ˆï¼‰
            function addRewardRecord(memberId, memberName, rewardType, rewardAmount, rewardTime, targetMemberId = '') {
                if (rewardAmount <= 0) return null;
                
                let rewards = JSON.parse(localStorage.getItem('rewards')) || [];
                let rewardId = getMaxId(rewards) + 1;
                let points = allocatePoints(rewardAmount);
                
                let newReward = {
                    id: rewardId,
                    memberId: memberId,
                    name: memberName,
                    type: rewardType,
                    amount: rewardAmount,
                    greenPoints: points.green,
                    redPoints: points.red,
                    rewardTime: rewardTime,
                    targetMemberId: targetMemberId
                };
                
                rewards.push(newReward);
                localStorage.setItem('rewards', JSON.stringify(rewards));
                syncRewardsToMembers();
                
                return newReward;
            }
            
            // æ£€æŸ¥16å¤©å¥–åŠ±
            function check16DayRewardForOrders() {
                let orders = JSON.parse(localStorage.getItem('orders')) || [];
                let currentDate = new Date($('#baseTime').text());
                let rewardCount = 0;
                
                orders.forEach(order => {
                    if (order.type === 'å¤è´­è®¢å•') return;
                    if (order.day16RewardStatus === 'å·²å‘æ”¾') return;
                    
                    let orderDate = new Date(order.orderTime);
                    let daysDiff = Math.floor((currentDate - orderDate) / (1000 * 60 * 60 * 24));
                    
                    if (daysDiff >= 16) {
                        addRewardRecord(
                            order.memberId,
                            order.name,
                            'ç³»ç»Ÿå¥–åŠ±',
                            DAY16_REWARD,
                            formatDate(currentDate),
                            order.id
                        );
                        
                        order.day16RewardStatus = 'å·²å‘æ”¾';
                        rewardCount++;
                    }
                });
                
                localStorage.setItem('orders', JSON.stringify(orders));
                refreshAllTables();
                
                if (rewardCount > 0) {
                    showSuccessMessage(`å·²ä¸º ${rewardCount} ä¸ªè®¢å•å‘æ”¾16å¤©å¥–åŠ±ï¼Œæ¯å•200å…ƒï¼`);
                } else {
                    showErrorMessage('å½“å‰æ²¡æœ‰å¯å‘æ”¾çš„16å¤©å¥–åŠ±ï¼');
                }
            }
            
            // è‡ªåŠ¨å¤è´­æ£€æŸ¥
            function checkAutoRepurchase(memberId) {
                let members = JSON.parse(localStorage.getItem('members')) || [];
                let orders = JSON.parse(localStorage.getItem('orders')) || [];
                let member = members.find(m => m.id === memberId);
                
                if (!member) return;
                if (!['åŒºä»£', 'å¸‚ä»£'].includes(member.level) || member.isEmptyAccount) return;
                if (member.greenPoints < AUTO_REPURCHASE_THRESHOLD) return;
                
                let today = formatDate(new Date());
                let existingRepurchase = orders.find(o => 
                    o.memberId === memberId && 
                    o.type === 'å¤è´­è®¢å•' && 
                    o.orderTime === today
                );
                
                if (existingRepurchase) return;
                
                let orderId = getMaxId(orders) + 1;
                let orderNo = 'LG' + formatDateForOrderNo(new Date()) + Math.floor(Math.random() * 10000).toString().padStart(4, '0');
                
                let newOrder = {
                    id: orderId,
                    memberId: memberId,
                    name: member.name,
                    amount: ORDER_PRICE,
                    type: 'å¤è´­è®¢å•',
                    orderNo: orderNo,
                    orderTime: today,
                    day16RewardStatus: 'æ— '
                };
                
                orders.push(newOrder);
                localStorage.setItem('orders', JSON.stringify(orders));
                
                addRewardRecord(
                    memberId,
                    member.name,
                    'ç›´æ¨å¥–',
                    calculateDirectReward(),
                    today,
                    memberId
                );
                
                showSuccessMessage(`ä¼šå‘˜ã€${member.name}ã€‘ç»¿ç§¯åˆ†æ”¶ç›Šæ»¡${AUTO_REPURCHASE_THRESHOLD}å…ƒï¼Œå·²è‡ªåŠ¨å¤è´­ä¸€å•ï¼`);
                refreshAllTables();
            }
            
            // ç›‘æ§ç»¿ç§¯åˆ†
            function monitorGreenPoints() {
                let members = JSON.parse(localStorage.getItem('members')) || [];
                let warnings = [];
                
                members.forEach(member => {
                    if (['åŒºä»£', 'å¸‚ä»£'].includes(member.level) && !member.isEmptyAccount) {
                        if (member.greenPoints >= AUTO_REPURCHASE_THRESHOLD) {
                            warnings.push({
                                id: member.id,
                                name: member.name,
                                greenPoints: member.greenPoints.toFixed(2)
                            });
                        }
                    }
                });
                
                if (warnings.length > 0) {
                    $('#greenPointsMonitor').show();
                    let alertText = warnings.map(w => 
                        `<span class="green-points-warning">${w.name}(ID:${w.id})ç»¿ç§¯åˆ†:${w.greenPoints}å…ƒ</span>`
                    ).join(' | ');
                    $('#greenPointsAlert').html(alertText);
                } else {
                    $('#greenPointsMonitor').hide();
                    $('#greenPointsAlert').empty();
                }
            }
            
            // åŠ è½½ä¼šå‘˜è¡¨æ ¼ï¼ˆä¼˜åŒ–ç‰ˆï¼‰
            function loadMemberTable() {
                let members = JSON.parse(localStorage.getItem('members')) || [];
                let tbody = $('#memberTableBody');
                tbody.empty();
                
                if(members.length === 0) {
                    tbody.append('<tr><td colspan="20" class="text-center py-4">æš‚æ— ä¼šå‘˜æ•°æ®</td></tr>');
                    return;
                }
                
                // æŒ‰IDå€’åºæ’åˆ—ï¼Œè®©æœ€æ–°æ·»åŠ çš„æ˜¾ç¤ºåœ¨æœ€ä¸Šé¢
                members.sort((a, b) => b.id - a.id);
                
                // ä½¿ç”¨æ–‡æ¡£ç‰‡æ®µæé«˜æ€§èƒ½
                let fragment = document.createDocumentFragment();
                
                members.forEach(member => {
                    // ç¡®ä¿æ‰€æœ‰å­—æ®µéƒ½æœ‰å€¼
                    member.directPush = member.directPush || 0;
                    member.repurchaseTimes = member.repurchaseTimes || 0;
                    member.orderCount = member.orderCount || 0;
                    member.totalPerformance = member.totalPerformance || 0;
                    member.systemReward = member.systemReward || 0;
                    member.directReward = member.directReward || 0;
                    member.areaReward = member.areaReward || 0;
                    member.peerReward = member.peerReward || 0;
                    member.cityReward = member.cityReward || 0;
                    member.greenPoints = member.greenPoints || 0;
                    member.redPoints = member.redPoints || 0;
                    member.totalIncome = member.totalIncome || 0;
                    member.level = member.level || 'ä¼šå‘˜';
                    member.isReinvest = member.isReinvest || false;
                    member.isEmptyAccount = member.isEmptyAccount || false;
                    
                    let isReinvestText = member.isReinvest ? 'æ˜¯' : 'å¦';
                    let isEmptyAccountText = member.isEmptyAccount ? '<span class="badge bg-danger">æ˜¯ç©ºå·</span>' : '<span class="badge bg-success">éç©ºå·</span>';
                    let totalIncome = (member.systemReward + member.directReward + member.areaReward + member.peerReward + member.cityReward).toFixed(2);
                    
                    let levelClass = '';
                    if (member.level === 'åŒºä»£') levelClass = 'level-area';
                    if (member.level === 'å¸‚ä»£') levelClass = 'level-city';
                    
                    let greenPointsCell = parseFloat(member.greenPoints).toFixed(2);
                    if (['åŒºä»£', 'å¸‚ä»£'].includes(member.level) && member.greenPoints >= AUTO_REPURCHASE_THRESHOLD) {
                        greenPointsCell = `<span class="green-points-warning">${greenPointsCell}</span>`;
                    }
                    
                    let row = document.createElement('tr');
                    row.innerHTML = `
                        <td>
                            <span class="member-link" data-id="${member.id}" style="cursor: pointer; color: #0d6efd; text-decoration: underline;">
                                ${member.id}
                            </span>
                        </td>
                        <td>${member.name}</td>
                        <td>
                            ${member.referrer ? 
                                `<span class="member-link" data-id="${member.referrer}" style="cursor: pointer; color: #0d6efd; text-decoration: underline;">
                                    ${member.referrer}
                                </span>` : 
                                '-'
                            }
                        </td>
                        <td>${member.contactPerson || '-'}</td>
                        <td>${member.directPush}</td>
                        <td class="${levelClass}">${member.level}</td>
                        <td>${member.repurchaseTimes}</td>
                        <td>${isReinvestText}</td>
                        <td>${member.totalPerformance.toLocaleString()}</td>
                        <td>${parseFloat(member.systemReward).toFixed(2)}</td>
                        <td>${parseFloat(member.directReward).toFixed(2)}</td>
                        <td>${parseFloat(member.areaReward).toFixed(2)}</td>
                        <td>${parseFloat(member.peerReward).toFixed(2)}</td>
                        <td>${parseFloat(member.cityReward).toFixed(2)}</td>
                        <td>${greenPointsCell}</td>
                        <td>${parseFloat(member.redPoints).toFixed(2)}</td>
                        <td>${totalIncome}</td>
                        <td>${member.registerTime}</td>
                        <td>${isEmptyAccountText}</td>
                        <td class="operation-btn">
                            <button class="btn btn-sm btn-warning edit-member" data-id="${member.id}">ç¼–è¾‘</button>
                            <button class="btn btn-sm btn-danger delete-member" data-id="${member.id}">åˆ é™¤</button>
                            <button class="btn btn-sm btn-success quick-order" data-id="${member.id}" data-name="${member.name}">å¿«é€Ÿä¸‹å•</button>
                        </td>
                    `;
                    fragment.appendChild(row);
                });
                
                tbody.append(fragment);
            }
            
            // åŠ è½½è®¢å•è¡¨æ ¼ï¼ˆä¼˜åŒ–ç‰ˆï¼‰
            function loadOrderTable() {
                let orders = JSON.parse(localStorage.getItem('orders')) || [];
                let tbody = $('#orderTableBody');
                tbody.empty();
                
                if(orders.length === 0) {
                    tbody.append('<tr><td colspan="9" class="text-center py-4">æš‚æ— è®¢å•æ•°æ®</td></tr>');
                    return;
                }
                
                // æŒ‰IDå€’åºæ’åˆ—ï¼Œè®©æœ€æ–°æ·»åŠ çš„æ˜¾ç¤ºåœ¨æœ€ä¸Šé¢
                orders.sort((a, b) => b.id - a.id);
                
                // ä½¿ç”¨æ–‡æ¡£ç‰‡æ®µæé«˜æ€§èƒ½
                let fragment = document.createDocumentFragment();
                
                orders.forEach(order => {
                    let rewardStatus = order.day16RewardStatus || 'æœªåˆ°æ—¶é—´';
                    if (order.type === 'å¤è´­è®¢å•') rewardStatus = 'æ— ';
                    
                    let statusBadge = '';
                    if (rewardStatus === 'å·²å‘æ”¾') {
                        statusBadge = '<span class="badge bg-success">å·²å‘æ”¾</span>';
                    } else if (rewardStatus === 'æœªåˆ°æ—¶é—´') {
                        statusBadge = '<span class="badge bg-warning">æœªåˆ°æ—¶é—´</span>';
                    } else {
                        statusBadge = '<span class="badge bg-secondary">æ— </span>';
                    }
                    
                    let row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${order.id}</td>
                        <td>${order.memberId}</td>
                        <td>${order.name}</td>
                        <td>${order.amount.toFixed(2)}</td>
                        <td>${order.type}</td>
                        <td>${order.orderNo}</td>
                        <td>${order.orderTime}</td>
                        <td>${statusBadge}</td>
                        <td class="operation-btn">
                            <button class="btn btn-sm btn-warning edit-order" data-id="${order.id}">ç¼–è¾‘</button>
                            <button class="btn btn-sm btn-danger delete-order" data-id="${order.id}">åˆ é™¤</button>
                        </td>
                    `;
                    fragment.appendChild(row);
                });
                
                tbody.append(fragment);
            }
            
            // åŠ è½½å¥–åŠ±è¡¨æ ¼
            function loadRewardTable() {
                let rewards = JSON.parse(localStorage.getItem('rewards')) || [];
                renderRewardTable(rewards);
            }
            
            function renderRewardTable(rewards) {
                let tbody = $('#rewardTableBody');
                tbody.empty();
                
                if(rewards.length === 0) {
                    tbody.append('<tr><td colspan="10" class="text-center py-4">æš‚æ— å¥–åŠ±æ•°æ®</td></tr>');
                    return;
                }
                
                // æŒ‰IDå€’åºæ’åˆ—ï¼Œè®©æœ€æ–°æ·»åŠ çš„æ˜¾ç¤ºåœ¨æœ€ä¸Šé¢
                rewards.sort((a, b) => b.id - a.id);
                
                // ä½¿ç”¨æ–‡æ¡£ç‰‡æ®µæé«˜æ€§èƒ½
                let fragment = document.createDocumentFragment();
                
                rewards.forEach(reward => {
                    let row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${reward.id}</td>
                        <td>${reward.memberId}</td>
                        <td>${reward.name}</td>
                        <td>${reward.type}</td>
                        <td>${reward.amount.toFixed(2)}</td>
                        <td>${reward.greenPoints.toFixed(2)}</td>
                        <td>${reward.redPoints.toFixed(2)}</td>
                        <td>${reward.rewardTime}</td>
                        <td>${reward.targetMemberId || '-'}</td>
                        <td class="operation-btn">
                            <button class="btn btn-sm btn-warning edit-reward" data-id="${reward.id}">ç¼–è¾‘</button>
                            <button class="btn btn-sm btn-danger delete-reward" data-id="${reward.id}">åˆ é™¤</button>
                        </td>
                    `;
                    fragment.appendChild(row);
                });
                
                tbody.append(fragment);
            }
            
            // åˆ·æ–°æ‰€æœ‰è¡¨æ ¼ï¼ˆä¼˜åŒ–ç‰ˆï¼‰
            function refreshAllTables() {
                // æ¸…ç©ºç¼“å­˜
                clearCache();
                
                recalculateDirectPush();
                syncRewardsToMembers();
                autoUpgradeAllMembers();
                monitorGreenPoints();
                loadMemberTable();
                loadOrderTable();
                loadRewardTable();
                refreshStatistics();
            }
            
            // åˆ·æ–°ç»Ÿè®¡æŠ¥è¡¨
            function refreshStatistics() {
                generateStatistics();
            }
            
            // ç”Ÿæˆç»Ÿè®¡æ•°æ®
            function generateStatistics() {
                let orders = JSON.parse(localStorage.getItem('orders')) || [];
                let rewards = JSON.parse(localStorage.getItem('rewards')) || [];
                let members = JSON.parse(localStorage.getItem('members')) || [];
                
                // 1. æ€»ä½“æ¦‚è§ˆ
                let totalOrders = orders.length;
                let totalRevenue = totalOrders * ORDER_PRICE;
                let totalRewards = rewards.reduce((sum, r) => sum + r.amount, 0);
                let totalMembers = members.length;
                
                $('#totalOrders').text(totalOrders);
                $('#totalRevenue').text(totalRevenue.toLocaleString());
                $('#totalRewards').text(totalRewards.toFixed(2));
                $('#totalMembers').text(totalMembers);
                
                // 2. å¥–åŠ±ç±»å‹åˆ†å¸ƒ
                let rewardTypeStats = {};
                rewards.forEach(reward => {
                    if (!rewardTypeStats[reward.type]) {
                        rewardTypeStats[reward.type] = {
                            count: 0,
                            amount: 0
                        };
                    }
                    rewardTypeStats[reward.type].count++;
                    rewardTypeStats[reward.type].amount += reward.amount;
                });
                
                let rewardTypeTbody = $('#rewardTypeStats');
                rewardTypeTbody.empty();
                let totalRewardAmount = totalRewards;
                
                Object.keys(rewardTypeStats).forEach(type => {
                    let stats = rewardTypeStats[type];
                    let percentage = totalRewardAmount > 0 ? (stats.amount / totalRewardAmount * 100).toFixed(2) : 0;
                    
                    rewardTypeTbody.append(`
                        <tr>
                            <td>${type}</td>
                            <td>${stats.count}</td>
                            <td>${stats.amount.toFixed(2)}</td>
                            <td>${percentage}%</td>
                        </tr>
                    `);
                });
                
                // 3. æ¯æ—¥ç»Ÿè®¡
                let dailyStats = {};
                orders.forEach(order => {
                    let date = order.orderTime;
                    if (!dailyStats[date]) {
                        dailyStats[date] = {
                            orders: 0,
                            revenue: 0,
                            rewards: 0,
                            rewardAmount: 0
                        };
                    }
                    dailyStats[date].orders++;
                    dailyStats[date].revenue += order.amount;
                });
                
                rewards.forEach(reward => {
                    let date = reward.rewardTime;
                    if (!dailyStats[date]) {
                        dailyStats[date] = {
                            orders: 0,
                            revenue: 0,
                            rewards: 0,
                            rewardAmount: 0
                        };
                    }
                    dailyStats[date].rewards++;
                    dailyStats[date].rewardAmount += reward.amount;
                });
                
                // æŒ‰æ—¥æœŸæ’åº
                let sortedDates = Object.keys(dailyStats).sort();
                let dailyStatsTbody = $('#dailyStatsTable');
                dailyStatsTbody.empty();
                
                let dailyTotalOrders = 0;
                let dailyTotalRevenue = 0;
                let dailyTotalRewards = 0;
                let dailyTotalRewardAmount = 0;
                
                sortedDates.forEach(date => {
                    let stats = dailyStats[date];
                    dailyTotalOrders += stats.orders;
                    dailyTotalRevenue += stats.revenue;
                    dailyTotalRewards += stats.rewards;
                    dailyTotalRewardAmount += stats.rewardAmount;
                    
                    dailyStatsTbody.append(`
                        <tr>
                            <td>${date}</td>
                            <td>${stats.orders}</td>
                            <td>${stats.revenue.toFixed(2)}</td>
                            <td>${stats.rewards}</td>
                            <td>${stats.rewardAmount.toFixed(2)}</td>
                        </tr>
                    `);
                });
                
                $('#dailyTotalOrders').text(dailyTotalOrders);
                $('#dailyTotalRevenue').text(dailyTotalRevenue.toFixed(2));
                $('#dailyTotalRewards').text(dailyTotalRewards);
                $('#dailyTotalRewardAmount').text(dailyTotalRewardAmount.toFixed(2));
                
                // 4. è¯¦ç»†ç»Ÿè®¡è¡¨
                let detailedStats = {};
                let totalNormalOrders = 0;
                let totalRepurchaseOrders = 0;
                let total16DayRewards = 0;
                let totalSystemRewards = 0;
                let totalDirectRewards = 0;
                let totalAreaRewards = 0;
                let totalPeerRewards = 0;
                let totalCityRewards = 0;
                let totalGreenPoints = 0;
                let totalRedPoints = 0;
                
                // è®¢å•ç»Ÿè®¡
                orders.forEach(order => {
                    let date = order.orderTime;
                    if (!detailedStats[date]) {
                        detailedStats[date] = {
                            normalOrders: 0,
                            repurchaseOrders: 0,
                            totalOrders: 0,
                            totalAmount: 0,
                            day16Rewards: 0,
                            systemRewards: 0,
                            directRewards: 0,
                            areaRewards: 0,
                            peerRewards: 0,
                            cityRewards: 0,
                            totalRewards: 0,
                            greenPoints: 0,
                            redPoints: 0
                        };
                    }
                    
                    if (order.type === 'æ™®é€šè®¢å•') {
                        detailedStats[date].normalOrders++;
                        totalNormalOrders++;
                    } else {
                        detailedStats[date].repurchaseOrders++;
                        totalRepurchaseOrders++;
                    }
                    detailedStats[date].totalOrders++;
                    detailedStats[date].totalAmount += order.amount;
                    
                    // 16å¤©å¥–åŠ±
                    if (order.day16RewardStatus === 'å·²å‘æ”¾') {
                        detailedStats[date].day16Rewards += DAY16_REWARD;
                        total16DayRewards += DAY16_REWARD;
                        detailedStats[date].systemRewards += DAY16_REWARD;
                        totalSystemRewards += DAY16_REWARD;
                    }
                });
                
                // å¥–åŠ±ç»Ÿè®¡
                rewards.forEach(reward => {
                    let date = reward.rewardTime;
                    if (!detailedStats[date]) {
                        detailedStats[date] = {
                            normalOrders: 0,
                            repurchaseOrders: 0,
                            totalOrders: 0,
                            totalAmount: 0,
                            day16Rewards: 0,
                            systemRewards: 0,
                            directRewards: 0,
                            areaRewards: 0,
                            peerRewards: 0,
                            cityRewards: 0,
                            totalRewards: 0,
                            greenPoints: 0,
                            redPoints: 0
                        };
                    }
                    
                    switch(reward.type) {
                        case 'ç³»ç»Ÿå¥–åŠ±':
                            detailedStats[date].systemRewards += reward.amount;
                            totalSystemRewards += reward.amount;
                            break;
                        case 'ç›´æ¨å¥–':
                            detailedStats[date].directRewards += reward.amount;
                            totalDirectRewards += reward.amount;
                            break;
                        case 'åŒºä»£å¥–':
                            detailedStats[date].areaRewards += reward.amount;
                            totalAreaRewards += reward.amount;
                            break;
                        case 'å¹³çº§å¥–':
                            detailedStats[date].peerRewards += reward.amount;
                            totalPeerRewards += reward.amount;
                            break;
                        case 'å¸‚ä»£å¥–':
                            detailedStats[date].cityRewards += reward.amount;
                            totalCityRewards += reward.amount;
                            break;
                    }
                    
                    detailedStats[date].totalRewards += reward.amount;
                    detailedStats[date].greenPoints += reward.greenPoints;
                    detailedStats[date].redPoints += reward.redPoints;
                    totalGreenPoints += reward.greenPoints;
                    totalRedPoints += reward.redPoints;
                });
                
                // ç”Ÿæˆè¯¦ç»†ç»Ÿè®¡è¡¨
                let sortedDetailedDates = Object.keys(detailedStats).sort();
                let detailedStatsTbody = $('#detailedStatsTable');
                detailedStatsTbody.empty();
                
                sortedDetailedDates.forEach(date => {
                    let stats = detailedStats[date];
                    detailedStatsTbody.append(`
                        <tr>
                            <td>${date}</td>
                            <td>${stats.normalOrders}</td>
                            <td>${stats.repurchaseOrders}</td>
                            <td>${stats.totalOrders}</td>
                            <td>${stats.totalAmount.toFixed(2)}</td>
                            <td>${stats.day16Rewards.toFixed(2)}</td>
                            <td>${stats.systemRewards.toFixed(2)}</td>
                            <td>${stats.directRewards.toFixed(2)}</td>
                            <td>${stats.areaRewards.toFixed(2)}</td>
                            <td>${stats.peerRewards.toFixed(2)}</td>
                            <td>${stats.cityRewards.toFixed(2)}</td>
                            <td>${stats.totalRewards.toFixed(2)}</td>
                            <td>${stats.greenPoints.toFixed(2)}</td>
                            <td>${stats.redPoints.toFixed(2)}</td>
                        </tr>
                    `);
                });
                
                // æ›´æ–°æ€»è®¡è¡Œ
                $('#totalNormalOrders').text(totalNormalOrders);
                $('#totalRepurchaseOrders').text(totalRepurchaseOrders);
                $('#totalAllOrders').text(totalNormalOrders + totalRepurchaseOrders);
                $('#totalAllRevenue').text((totalNormalOrders + totalRepurchaseOrders) * ORDER_PRICE);
                $('#total16DayRewards').text(total16DayRewards.toFixed(2));
                $('#totalSystemRewards').text(totalSystemRewards.toFixed(2));
                $('#totalDirectRewards').text(totalDirectRewards.toFixed(2));
                $('#totalAreaRewards').text(totalAreaRewards.toFixed(2));
                $('#totalPeerRewards').text(totalPeerRewards.toFixed(2));
                $('#totalCityRewards').text(totalCityRewards.toFixed(2));
                $('#totalAllRewards').text((totalSystemRewards + totalDirectRewards + totalAreaRewards + totalPeerRewards + totalCityRewards).toFixed(2));
                $('#totalGreenPoints').text(totalGreenPoints.toFixed(2));
                $('#totalRedPoints').text(totalRedPoints.toFixed(2));
                
                // 5. ä¼šå‘˜çº§åˆ«åˆ†å¸ƒ
                let levelStats = {
                    'ä¼šå‘˜': { count: 0, totalPerformance: 0 },
                    'åŒºä»£': { count: 0, totalPerformance: 0 },
                    'å¸‚ä»£': { count: 0, totalPerformance: 0 }
                };
                
                members.forEach(member => {
                    if (levelStats[member.level]) {
                        levelStats[member.level].count++;
                        levelStats[member.level].totalPerformance += member.totalPerformance || 0;
                    }
                });
                
                let levelStatsTbody = $('#memberLevelStats');
                levelStatsTbody.empty();
                
                Object.keys(levelStats).forEach(level => {
                    let stats = levelStats[level];
                    let percentage = totalMembers > 0 ? (stats.count / totalMembers * 100).toFixed(2) : 0;
                    let avgPerformance = stats.count > 0 ? (stats.totalPerformance / stats.count).toFixed(2) : 0;
                    
                    levelStatsTbody.append(`
                        <tr>
                            <td>${level}</td>
                            <td>${stats.count}</td>
                            <td>${percentage}%</td>
                            <td>${parseFloat(avgPerformance).toLocaleString()}</td>
                        </tr>
                    `);
                });
                
                // 6. æ”¶ç›Šæ’è¡Œæ¦œ
                let sortedMembers = [...members]
                    .filter(m => m.totalIncome > 0)
                    .sort((a, b) => b.totalIncome - a.totalIncome)
                    .slice(0, 10);
                
                let incomeRankingTbody = $('#incomeRankingTable');
                incomeRankingTbody.empty();
                
                sortedMembers.forEach((member, index) => {
                    incomeRankingTbody.append(`
                        <tr>
                            <td>${index + 1}</td>
                            <td>${member.id}</td>
                            <td>${member.name}</td>
                            <td>${member.level}</td>
                            <td>${member.totalIncome.toFixed(2)}</td>
                        </tr>
                    `);
                });
            }
            
            // ================ ä¼˜åŒ–åçš„è®¡ç®—å‡½æ•° ================
            
            // è·å–ä¸Šçº§åŒºä»£ï¼ˆä¼˜åŒ–ç‰ˆ - é¿å…é€’å½’ï¼‰
            function getUpperAreaAgentsOptimized(memberId) {
                const cacheKey = `area_${memberId}`;
                if (upperAgentsCache[cacheKey]) {
                    return upperAgentsCache[cacheKey];
                }
                
                let members = JSON.parse(localStorage.getItem('members')) || [];
                let agentIds = new Set();
                
                // å‘ä¸ŠæŸ¥æ‰¾åŒºä»£
                let currentId = memberId;
                let visited = new Set();
                
                while (currentId) {
                    if (visited.has(currentId)) break;
                    visited.add(currentId);
                    
                    let member = members.find(m => m.id === currentId);
                    if (!member || !member.referrer) break;
                    
                    let referrerId = member.referrer;
                    let referrer = members.find(m => m.id === referrerId);
                    
                    if (referrer && referrer.level === 'åŒºä»£' && !referrer.isEmptyAccount) {
                        agentIds.add(referrerId);
                    }
                    
                    currentId = referrerId;
                }
                
                let result = Array.from(agentIds);
                upperAgentsCache[cacheKey] = result;
                return result;
            }
            
            // è·å–ä¸Šçº§å¸‚ä»£ï¼ˆä¼˜åŒ–ç‰ˆï¼‰
            function getUpperCityAgentsOptimized(memberId) {
                const cacheKey = `city_${memberId}`;
                if (upperAgentsCache[cacheKey]) {
                    return upperAgentsCache[cacheKey];
                }
                
                let members = JSON.parse(localStorage.getItem('members')) || [];
                let agentIds = new Set();
                
                // å‘ä¸ŠæŸ¥æ‰¾å¸‚ä»£
                let currentId = memberId;
                let visited = new Set();
                
                while (currentId) {
                    if (visited.has(currentId)) break;
                    visited.add(currentId);
                    
                    let member = members.find(m => m.id === currentId);
                    if (!member || !member.referrer) break;
                    
                    let referrerId = member.referrer;
                    let referrer = members.find(m => m.id === referrerId);
                    
                    if (referrer && referrer.level === 'å¸‚ä»£' && !referrer.isEmptyAccount) {
                        agentIds.add(referrerId);
                    }
                    
                    currentId = referrerId;
                }
                
                let result = Array.from(agentIds);
                upperAgentsCache[cacheKey] = result;
                return result;
            }
            
            // è·å–ä¸Šçº§åŒºä»£ï¼ˆç”¨äºå¹³çº§å¥– - ä¼˜åŒ–ç‰ˆï¼‰
            function getUpperAreaAgentForPeerRewardOptimized(memberId) {
                let members = JSON.parse(localStorage.getItem('members')) || [];
                let member = members.find(m => m.id === memberId);
                if (!member) return null;
                
                let referrerId = member.referrer;
                let visited = new Set();
                
                while (referrerId) {
                    if (visited.has(referrerId)) break;
                    visited.add(referrerId);
                    
                    let referrer = members.find(m => m.id === referrerId);
                    if (referrer && referrer.level === 'åŒºä»£' && !referrer.isEmptyAccount) {
                        return referrerId;
                    }
                    referrerId = referrer ? referrer.referrer : null;
                }
                
                return null;
            }
            
            // ================ æœç´¢åŠŸèƒ½ ================
            
            // æœç´¢ä¼šå‘˜å‡½æ•°
            function searchMembers() {
                let members = JSON.parse(localStorage.getItem('members')) || [];
                let searchId = $('#searchMemberId').val().trim();
                let searchName = $('#searchMemberName').val().trim();
                let filterLevel = $('#filterMemberLevel').val();
                
                // æ¸…ç©ºä¹‹å‰çš„æœç´¢ç»“æœ
                $('#searchResults').hide();
                $('#memberTree').empty();
                
                // å¦‚æœæ²¡æœ‰æœç´¢æ¡ä»¶ï¼Œæ˜¾ç¤ºæ‰€æœ‰ä¼šå‘˜
                if (!searchId && !searchName && !filterLevel) {
                    loadMemberTable();
                    return;
                }
                
                // ç­›é€‰ä¼šå‘˜
                let filteredMembers = members.filter(member => {
                    if (searchId && member.id !== parseInt(searchId)) return false;
                    if (searchName && !member.name.includes(searchName)) return false;
                    if (filterLevel && member.level !== filterLevel) return false;
                    return true;
                });
                
                if (filteredMembers.length === 0) {
                    $('#memberTree').html('<div class="text-center py-4">æœªæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„ä¼šå‘˜</div>');
                    $('#searchResults').show();
                    return;
                }
                
                // å¦‚æœåªæœç´¢ä¸€ä¸ªä¼šå‘˜ï¼Œæ˜¾ç¤ºè¯¥ä¼šå‘˜çš„ä¸‹çº¿ç»“æ„
                if (searchId && !searchName && !filterLevel) {
                    let memberId = parseInt(searchId);
                    displayMemberTree(memberId);
                } else {
                    // æ˜¾ç¤ºæœç´¢ç»“æœåˆ—è¡¨
                    displaySearchResults(filteredMembers);
                }
                
                $('#searchResults').show();
            }
            
            // æ˜¾ç¤ºæœç´¢ç»“æœåˆ—è¡¨
            function displaySearchResults(members) {
                let treeHtml = '<div class="mb-3"><strong>æ‰¾åˆ° ' + members.length + ' ä¸ªä¼šå‘˜ï¼š</strong></div>';
                
                members.forEach(member => {
                    let levelClass = '';
                    if (member.level === 'åŒºä»£') levelClass = 'level-area';
                    if (member.level === 'å¸‚ä»£') levelClass = 'level-city';
                    
                    treeHtml += `
                        <div class="tree-node level-1">
                            <span class="member-link" data-id="${member.id}">
                                ID: ${member.id} | å§“å: ${member.name} | çº§åˆ«: <span class="${levelClass}">${member.level}</span>
                            </span>
                            <button class="btn btn-sm btn-info float-end view-subordinates" data-id="${member.id}">æŸ¥çœ‹ä¸‹çº¿</button>
                        </div>
                    `;
                });
                
                $('#memberTree').html(treeHtml);
            }
            
            // æ˜¾ç¤ºä¼šå‘˜æ ‘å½¢ç»“æ„ï¼ˆä¸‹çº¿ä¼šå‘˜ï¼‰
            function displayMemberTree(rootMemberId) {
                let members = JSON.parse(localStorage.getItem('members')) || [];
                let rootMember = members.find(m => m.id === rootMemberId);
                
                if (!rootMember) {
                    $('#memberTree').html('<div class="text-center py-4">ä¼šå‘˜ä¸å­˜åœ¨</div>');
                    return;
                }
                
                // æ„å»ºæ ‘å½¢ç»“æ„
                let treeHtml = `
                    <div class="mb-3">
                        <strong>ä¼šå‘˜ç»“æ„æ ‘ (æ ¹èŠ‚ç‚¹: ${rootMember.name} ID:${rootMember.id})</strong>
                        <button class="btn btn-sm btn-outline-secondary float-end" id="collapseAllBtn">æŠ˜å å…¨éƒ¨</button>
                        <button class="btn btn-sm btn-outline-secondary float-end me-2" id="expandAllBtn">å±•å¼€å…¨éƒ¨</button>
                    </div>
                `;
                
                // é€’å½’å‡½æ•°æ„å»ºæ ‘
                function buildTree(memberId, level) {
                    let member = members.find(m => m.id === memberId);
                    if (!member) return '';
                    
                    let levelClass = `level-${Math.min(level, 5)}`;
                    let memberLevelClass = '';
                    if (member.level === 'åŒºä»£') memberLevelClass = 'level-area';
                    if (member.level === 'å¸‚ä»£') memberLevelClass = 'level-city';
                    
                    // è·å–ç›´æ¨ä¼šå‘˜
                    let directMembers = members.filter(m => m.referrer === memberId);
                    
                    let html = `
                        <div class="tree-node ${levelClass}">
                            <span class="member-link" data-id="${member.id}">
                                ${member.id} | ${member.name} | 
                                <span class="${memberLevelClass}">${member.level}</span> | 
                                ç›´æ¨: ${directMembers.length}
                            </span>
                    `;
                    
                    if (directMembers.length > 0) {
                        html += `<button class="btn btn-sm btn-outline-primary float-end toggle-btn" data-id="${member.id}">å±•å¼€</button>`;
                        html += `<div id="subtree-${member.id}" class="subtree" style="display: none;">`;
                        directMembers.forEach(subMember => {
                            html += buildTree(subMember.id, level + 1);
                        });
                        html += '</div>';
                    }
                    
                    html += '</div>';
                    return html;
                }
                
                treeHtml += buildTree(rootMemberId, 1);
                $('#memberTree').html(treeHtml);
                
                // æ·»åŠ åˆ‡æ¢æŒ‰é’®äº‹ä»¶
                $('.toggle-btn').click(function() {
                    let memberId = $(this).data('id');
                    let subtree = $('#subtree-' + memberId);
                    if (subtree.is(':visible')) {
                        subtree.hide();
                        $(this).text('å±•å¼€');
                    } else {
                        subtree.show();
                        $(this).text('æŠ˜å ');
                    }
                });
                
                // å±•å¼€å…¨éƒ¨æŒ‰é’®
                $('#expandAllBtn').click(function() {
                    $('.subtree').show();
                    $('.toggle-btn').text('æŠ˜å ');
                });
                
                // æŠ˜å å…¨éƒ¨æŒ‰é’®
                $('#collapseAllBtn').click(function() {
                    $('.subtree').hide();
                    $('.toggle-btn').text('å±•å¼€');
                });
            }
            
            // ================ ä¼˜åŒ–åçš„ä¸‹å•å‡½æ•° ================
            
            // ä¸ºä¼šå‘˜å¿«é€Ÿä¸‹å•
            $(document).on('click', '.quick-order', async function() {
                let memberId = $(this).data('id');
                let memberName = $(this).data('name');
                
                if (!memberId) {
                    showErrorMessage('ä¼šå‘˜IDä¸èƒ½ä¸ºç©ºï¼');
                    return;
                }
                
                if (confirm(`ç¡®å®šè¦ä¸ºä¼šå‘˜ã€${memberName}ã€‘(ID:${memberId})å¿«é€Ÿä¸‹å•å—ï¼Ÿ`)) {
                    showLoading('å¼€å§‹åˆ›å»ºè®¢å•...');
                    updateLoading(10, 'éªŒè¯ä¼šå‘˜ä¿¡æ¯...');
                    
                    try {
                        // ä½¿ç”¨setTimeoutåˆ†è§£ä»»åŠ¡ï¼Œé¿å…é˜»å¡UI
                        setTimeout(async () => {
                            await createQuickOrderOptimized(memberId, memberName);
                        }, 100);
                    } catch (error) {
                        showErrorMessage('ä¸‹å•å¤±è´¥ï¼š' + error.message);
                        console.error(error);
                        hideLoading();
                    }
                }
            });
            
            // ä¼˜åŒ–åçš„å¿«é€Ÿä¸‹å•å‡½æ•°
            async function createQuickOrderOptimized(memberId, memberName) {
                updateLoading(20, 'è¯»å–æ•°æ®...');
                
                let orders = JSON.parse(localStorage.getItem('orders')) || [];
                let members = JSON.parse(localStorage.getItem('members')) || [];
                
                // éªŒè¯ä¼šå‘˜
                let member = members.find(m => m.id === memberId);
                if (!member) {
                    hideLoading();
                    showErrorMessage('ä¼šå‘˜ä¸å­˜åœ¨ï¼');
                    return;
                }
                
                updateLoading(30, 'åˆ›å»ºè®¢å•è®°å½•...');
                
                let orderId = getMaxId(orders) + 1;
                let orderNo = 'LG' + formatDateForOrderNo(new Date()) + Math.floor(Math.random() * 10000).toString().padStart(4, '0');
                let orderType = 'æ™®é€šè®¢å•';
                let orderTime = formatDate(baseTime);
                
                let newOrder = {
                    id: orderId,
                    memberId: memberId,
                    name: memberName,
                    amount: ORDER_PRICE,
                    type: orderType,
                    orderNo: orderNo,
                    orderTime: orderTime,
                    day16RewardStatus: 'æœªåˆ°æ—¶é—´'
                };
                
                orders.push(newOrder);
                localStorage.setItem('orders', JSON.stringify(orders));
                
                updateLoading(40, 'æ›´æ–°ä¼šå‘˜çŠ¶æ€...');
                
                // æ›´æ–°ä¼šå‘˜çŠ¶æ€ï¼ˆä¸å†æ˜¯ç©ºå·ï¼‰
                member.isEmptyAccount = false;
                member.orderCount = (member.orderCount || 0) + 1;
                localStorage.setItem('members', JSON.stringify(members));
                
                updateLoading(50, 'è®¡ç®—å¥–åŠ±...');
                
                // å¼‚æ­¥è®¡ç®—å¥–åŠ±
                await calculateOrderRewardsOptimized(memberId, orderTime, memberName);
                
                updateLoading(80, 'åˆ·æ–°ç•Œé¢...');
                
                // ä½¿ç”¨setTimeoutå»¶è¿Ÿåˆ·æ–°ï¼Œè®©UIæœ‰æœºä¼šæ›´æ–°
                setTimeout(() => {
                    refreshAllTables();
                    updateLoading(100, 'ä¸‹å•å®Œæˆï¼');
                    
                    setTimeout(() => {
                        hideLoading();
                        showSuccessMessage(`ä¸ºä¼šå‘˜ã€${memberName}ã€‘å¿«é€Ÿä¸‹å•æˆåŠŸï¼è®¢å•ç¼–å·ï¼š${newOrder.orderNo}`);
                    }, 500);
                }, 300);
            }
            
            // ä¼˜åŒ–åçš„è®¡ç®—è®¢å•å¥–åŠ±å‡½æ•°
            async function calculateOrderRewardsOptimized(memberId, orderTime, memberName) {
                return new Promise((resolve) => {
                    // åˆ†è§£ä»»åŠ¡ï¼Œé¿å…é•¿æ—¶é—´é˜»å¡
                    setTimeout(() => {
                        updateLoading(55, 'è®¡ç®—ç›´æ¨å¥–...');
                        calculateDirectRewards(memberId, orderTime);
                        
                        setTimeout(() => {
                            updateLoading(60, 'è®¡ç®—åŒºä»£å¥–...');
                            calculateAreaRewards(memberId, orderTime);
                            
                            setTimeout(() => {
                                updateLoading(65, 'è®¡ç®—å¹³çº§å¥–...');
                                calculatePeerRewards(memberId, orderTime);
                                
                                setTimeout(() => {
                                    updateLoading(70, 'è®¡ç®—å¸‚ä»£å¥–...');
                                    calculateCityRewards(memberId, orderTime);
                                    
                                    setTimeout(() => {
                                        updateLoading(75, 'æ£€æŸ¥è‡ªåŠ¨å¤è´­...');
                                        checkAutoRepurchase(memberId);
                                        resolve();
                                    }, 100);
                                }, 100);
                            }, 100);
                        }, 100);
                    }, 100);
                });
            }
            
            // åˆ†è§£çš„è®¡ç®—å‡½æ•°
            function calculateDirectRewards(memberId, orderTime) {
                let members = JSON.parse(localStorage.getItem('members')) || [];
                let rewards = JSON.parse(localStorage.getItem('rewards')) || [];
                let member = members.find(m => m.id === memberId);
                if (!member) return;
                
                // ç›´æ¨å¥–ï¼ˆç»™æ¨èäººï¼‰
                if (member.referrer) {
                    let referrer = members.find(m => m.id === member.referrer);
                    if (referrer && !referrer.isEmptyAccount) {
                        let directRewardAmount = calculateDirectReward(); // 5%çš„è®¢å•é‡‘é¢
                        
                        // å¦‚æœæ¨èäººæ˜¯åŒºä»£ï¼Œéœ€è¦è€ƒè™‘æ¯æ—¥å°é¡¶
                        if (referrer.level === 'åŒºä»£') {
                            // è®¡ç®—è¯¥åŒºä»£å½“æ—¥å·²è·å¾—çš„æ‰€æœ‰å¥–åŠ±ï¼ˆç›´æ¨å¥–+å¹³çº§å¥–+åŒºä»£å¥–ï¼‰æ€»å’Œ
                            let todayTotal = rewards
                                .filter(r => r.memberId === referrer.id && 
                                            r.rewardTime === orderTime &&
                                            ['ç›´æ¨å¥–', 'å¹³çº§å¥–', 'åŒºä»£å¥–'].includes(r.type))
                                .reduce((sum, r) => sum + r.amount, 0);
                            
                            // è®¡ç®—å‰©ä½™é¢åº¦
                            let remaining = AREA_AGENT_DAILY_CAP - todayTotal;
                            
                            if (remaining > 0) {
                                let actualReward = Math.min(directRewardAmount, remaining);
                                addRewardRecord(
                                    referrer.id,
                                    referrer.name,
                                    'ç›´æ¨å¥–',
                                    actualReward,
                                    orderTime,
                                    memberId
                                );
                            }
                        } else {
                            // éåŒºä»£ï¼Œæ­£å¸¸å‘æ”¾
                            addRewardRecord(
                                referrer.id,
                                referrer.name,
                                'ç›´æ¨å¥–',
                                directRewardAmount,
                                orderTime,
                                memberId
                            );
                        }
                    }
                }
            }
            
            function calculateAreaRewards(memberId, orderTime) {
                let members = JSON.parse(localStorage.getItem('members')) || [];
                let rewards = JSON.parse(localStorage.getItem('rewards')) || [];
                
                // åŒºä»£å¥–å’Œå¹³çº§å¥–
                let areaAgents = getUpperAreaAgentsOptimized(memberId);
                areaAgents.forEach(agentId => {
                    let agent = members.find(m => m.id === agentId);
                    if (agent && !agent.isEmptyAccount && agent.level === 'åŒºä»£') {
                        let areaReward = calculateAreaReward(agentId, orderTime);
                        if (areaReward > 0) {
                            addRewardRecord(
                                agentId,
                                agent.name,
                                'åŒºä»£å¥–',
                                areaReward,
                                orderTime,
                                memberId
                            );
                        }
                    }
                });
            }
            
            function calculatePeerRewards(memberId, orderTime) {
                let members = JSON.parse(localStorage.getItem('members')) || [];
                let rewards = JSON.parse(localStorage.getItem('rewards')) || [];
                
                // å¹³çº§å¥–ï¼ˆä¿®æ”¹ç‚¹1ï¼šå¹³çº§å¥–æ˜¯ä¸‹é¢åŒºä»£çš„åŒºä»£å¥–çš„100%ï¼‰
                let areaAgents = getUpperAreaAgentsOptimized(memberId);
                areaAgents.forEach(agentId => {
                    let agent = members.find(m => m.id === agentId);
                    if (agent && !agent.isEmptyAccount && agent.level === 'åŒºä»£') {
                        // è·å–ä¸Šçº§åŒºä»£ï¼ˆå¹³çº§å¥–çš„å‘æ”¾å¯¹è±¡ï¼‰
                        let upperAreaAgentId = getUpperAreaAgentForPeerRewardOptimized(agentId);
                        if (upperAreaAgentId) {
                            let upperAgent = members.find(m => m.id === upperAreaAgentId);
                            if (upperAgent && upperAgent.level === 'åŒºä»£' && !upperAgent.isEmptyAccount) {
                                // è®¡ç®—è¯¥åŒºä»£ï¼ˆagentï¼‰å½“å¤©å·²ç»è·å¾—çš„åŒºä»£å¥–æ€»é¢
                                let areaRewardToday = rewards
                                    .filter(r => r.memberId === agentId && 
                                                r.rewardTime === orderTime &&
                                                r.type === 'åŒºä»£å¥–')
                                    .reduce((sum, r) => sum + r.amount, 0);
                                
                                // å¹³çº§å¥– = åŒºä»£å¥–çš„100%
                                let peerRewardAmount = areaRewardToday;
                                
                                // è®¡ç®—ä¸Šçº§åŒºä»£å½“æ—¥å·²è·å¾—çš„æ‰€æœ‰å¥–åŠ±ï¼ˆç›´æ¨å¥–+å¹³çº§å¥–+åŒºä»£å¥–ï¼‰æ€»å’Œ
                                let todayTotal = rewards
                                    .filter(r => r.memberId === upperAreaAgentId && 
                                                r.rewardTime === orderTime &&
                                                ['ç›´æ¨å¥–', 'å¹³çº§å¥–', 'åŒºä»£å¥–'].includes(r.type))
                                    .reduce((sum, r) => sum + r.amount, 0);
                                
                                // è®¡ç®—å‰©ä½™é¢åº¦
                                let remaining = AREA_AGENT_DAILY_CAP - todayTotal;
                                
                                if (remaining > 0 && peerRewardAmount > 0) {
                                    let actualReward = Math.min(peerRewardAmount, remaining);
                                    addRewardRecord(
                                        upperAreaAgentId,
                                        upperAgent.name,
                                        'å¹³çº§å¥–',
                                        actualReward,
                                        orderTime,
                                        agentId
                                    );
                                }
                            }
                        }
                    }
                });
            }
            
            function calculateCityRewards(memberId, orderTime) {
                let members = JSON.parse(localStorage.getItem('members')) || [];
                
                // å¸‚ä»£å¥–
                let cityAgents = getUpperCityAgentsOptimized(memberId);
                cityAgents.forEach(agentId => {
                    let agent = members.find(m => m.id === agentId);
                    if (agent && !agent.isEmptyAccount && agent.level === 'å¸‚ä»£') {
                        let cityReward = calculateCityReward();
                        addRewardRecord(
                            agentId,
                            agent.name,
                            'å¸‚ä»£å¥–',
                            cityReward,
                            orderTime,
                            memberId
                        );
                    }
                });
            }
            
            // ================ äº‹ä»¶ç»‘å®š ================
            
            $('#minusDay').click(function() {
                baseTime.setDate(baseTime.getDate() - 1);
                updateBaseTimeDisplay();
            });
            
            $('#addDay').click(function() {
                baseTime.setDate(baseTime.getDate() + 1);
                updateBaseTimeDisplay();
            });
            
            $('#check16DayReward').click(function() {
                check16DayRewardForOrders();
            });
            
            $('#createDemoData').click(function() {
                if (confirm('ç¡®å®šè¦åˆ›å»ºæ¼”ç¤ºæ•°æ®å—ï¼Ÿè¿™å°†æ·»åŠ 13ä¸ªä¼šå‘˜ï¼ˆ1æ¨3ï¼Œ3æ¨9ç»“æ„ï¼‰å’Œä¸€äº›è®¢å•å¥–åŠ±æ•°æ®ã€‚')) {
                    showLoading('æ­£åœ¨åˆ›å»ºæ¼”ç¤ºæ•°æ®...');
                    setTimeout(() => {
                        createDemoData();
                        hideLoading();
                    }, 100);
                }
            });
            
            // æœç´¢æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            $('#searchMemberBtn').click(function() {
                searchMembers();
            });
            
            // æ¸…ç©ºæœç´¢æŒ‰é’®
            $('#clearSearchBtn').click(function() {
                $('#searchMemberId').val('');
                $('#searchMemberName').val('');
                $('#filterMemberLevel').val('');
                $('#searchResults').hide();
                loadMemberTable();
            });
            
            // ç‚¹å‡»ä¼šå‘˜IDæŸ¥çœ‹ä¸‹çº¿
            $(document).on('click', '.member-link', function(e) {
                e.stopPropagation();
                let memberId = $(this).data('id');
                if (memberId) {
                    // å¡«å……æœç´¢æ¡†å¹¶æœç´¢
                    $('#searchMemberId').val(memberId);
                    $('#searchMemberName').val('');
                    $('#filterMemberLevel').val('');
                    searchMembers();
                    
                    // åˆ‡æ¢åˆ°ä¼šå‘˜æ ‡ç­¾é¡µï¼ˆå¦‚æœä¸åœ¨çš„è¯ï¼‰
                    $('button[data-bs-target="#member"]').tab('show');
                }
            });
            
            // æŸ¥çœ‹ä¸‹çº¿æŒ‰é’®
            $(document).on('click', '.view-subordinates', function(e) {
                e.stopPropagation();
                let memberId = $(this).data('id');
                $('#searchMemberId').val(memberId);
                $('#searchMemberName').val('');
                $('#filterMemberLevel').val('');
                searchMembers();
            });
            
            // æœç´¢æ¡†å›è½¦äº‹ä»¶
            $('#searchMemberId, #searchMemberName').keypress(function(e) {
                if (e.which === 13) { // Enteré”®
                    searchMembers();
                }
            });
            
            // åˆ›å»ºæ¼”ç¤ºæ•°æ®
            function createDemoData() {
                let members = [];
                let orders = [];
                let rewards = [];
                
                // æ ¹èŠ‚ç‚¹ï¼ˆæ¨èäººï¼‰
                let rootMember = {
                    id: 1,
                    name: 'å¼ ä¸‰',
                    referrer: '',
                    contactPerson: '',
                    directPush: 0,
                    level: 'ä¼šå‘˜',
                    repurchaseTimes: 0,
                    orderCount: 1,
                    totalPerformance: ORDER_PRICE,
                    systemReward: 0,
                    directReward: 0,
                    areaReward: 0,
                    peerReward: 0,
                    cityReward: 0,
                    greenPoints: 0,
                    redPoints: 0,
                    totalIncome: 0,
                    registerTime: '2025-09-01',
                    isReinvest: false,
                    isEmptyAccount: false
                };
                members.push(rootMember);
                
                // ç¬¬ä¸€å±‚ï¼ˆ3ä¸ªç›´æ¥æ¨èï¼‰
                let firstLayerNames = ['æå››', 'ç‹äº”', 'èµµå…­'];
                for (let i = 0; i < 3; i++) {
                    let member = {
                        id: i + 2,
                        name: firstLayerNames[i],
                        referrer: 1,
                        contactPerson: 1,
                        directPush: 3,
                        level: i === 0 ? 'åŒºä»£' : 'ä¼šå‘˜',
                        repurchaseTimes: 0,
                        orderCount: 1,
                        totalPerformance: ORDER_PRICE,
                        systemReward: 0,
                        directReward: 0,
                        areaReward: 0,
                        peerReward: 0,
                        cityReward: 0,
                        greenPoints: 0,
                        redPoints: 0,
                        totalIncome: 0,
                        registerTime: '2025-09-02',
                        isReinvest: false,
                        isEmptyAccount: false
                    };
                    members.push(member);
                }
                
                // ç¬¬äºŒå±‚ï¼ˆ9ä¸ªä¼šå‘˜ï¼‰
                let secondLayerNames = ['é’±ä¸ƒ', 'å­™å…«', 'å‘¨ä¹', 'å´å', 'éƒ‘åä¸€', 'ç‹åäºŒ', 'å†¯åä¸‰', 'é™ˆåå››', 'è¤šåäº”'];
                let referrerIds = [2, 2, 2, 3, 3, 3, 4, 4, 4];
                
                for (let i = 0; i < 9; i++) {
                    let member = {
                        id: i + 5,
                        name: secondLayerNames[i],
                        referrer: referrerIds[i],
                        contactPerson: referrerIds[i],
                        directPush: 0,
                        level: 'ä¼šå‘˜',
                        repurchaseTimes: 0,
                        orderCount: i < 3 ? 1 : 0,
                        totalPerformance: i < 3 ? ORDER_PRICE : 0,
                        systemReward: 0,
                        directReward: 0,
                        areaReward: 0,
                        peerReward: 0,
                        cityReward: 0,
                        greenPoints: i < 3 ? 149.85 : 0,
                        redPoints: i < 3 ? 49.95 : 0,
                        totalIncome: 0,
                        registerTime: '2025-09-03',
                        isReinvest: false,
                        isEmptyAccount: i >= 3
                    };
                    members.push(member);
                }
                
                // åˆ›å»ºè®¢å•
                let demoOrders = [
                    { id: 1, memberId: 1, name: 'å¼ ä¸‰', amount: ORDER_PRICE, type: 'æ™®é€šè®¢å•', orderTime: '2025-09-01', day16RewardStatus: 'å·²å‘æ”¾' },
                    { id: 2, memberId: 2, name: 'æå››', amount: ORDER_PRICE, type: 'æ™®é€šè®¢å•', orderTime: '2025-09-02', day16RewardStatus: 'å·²å‘æ”¾' },
                    { id: 3, memberId: 3, name: 'ç‹äº”', amount: ORDER_PRICE, type: 'æ™®é€šè®¢å•', orderTime: '2025-09-02', day16RewardStatus: 'å·²å‘æ”¾' },
                    { id: 4, memberId: 4, name: 'èµµå…­', amount: ORDER_PRICE, type: 'æ™®é€šè®¢å•', orderTime: '2025-09-02', day16RewardStatus: 'å·²å‘æ”¾' },
                    { id: 5, memberId: 5, name: 'é’±ä¸ƒ', amount: ORDER_PRICE, type: 'æ™®é€šè®¢å•', orderTime: '2025-09-03', day16RewardStatus: 'å·²å‘æ”¾' },
                    { id: 6, memberId: 6, name: 'å­™å…«', amount: ORDER_PRICE, type: 'æ™®é€šè®¢å•', orderTime: '2025-09-03', day16RewardStatus: 'å·²å‘æ”¾' },
                    { id: 7, memberId: 7, name: 'å‘¨ä¹', amount: ORDER_PRICE, type: 'æ™®é€šè®¢å•', orderTime: '2025-09-03', day16RewardStatus: 'å·²å‘æ”¾' }
                ];
                
                // ç”Ÿæˆè®¢å•å·
                demoOrders.forEach((order, index) => {
                    order.orderNo = 'LG' + order.orderTime.replace(/-/g, '') + (index + 1).toString().padStart(4, '0');
                    orders.push(order);
                });
                
                // åˆ›å»ºå¥–åŠ±è®°å½•
                let demoRewards = [
                    { memberId: 1, name: 'å¼ ä¸‰', type: 'ç›´æ¨å¥–', amount: 99.9, rewardTime: '2025-09-02', targetMemberId: 2 },
                    { memberId: 1, name: 'å¼ ä¸‰', type: 'ç›´æ¨å¥–', amount: 99.9, rewardTime: '2025-09-02', targetMemberId: 3 },
                    { memberId: 1, name: 'å¼ ä¸‰', type: 'ç›´æ¨å¥–', amount: 99.9, rewardTime: '2025-09-02', targetMemberId: 4 },
                    { memberId: 2, name: 'æå››', type: 'ç›´æ¨å¥–', amount: 99.9, rewardTime: '2025-09-03', targetMemberId: 5 },
                    { memberId: 2, name: 'æå››', type: 'ç›´æ¨å¥–', amount: 99.9, rewardTime: '2025-09-03', targetMemberId: 6 },
                    { memberId: 2, name: 'æå››', type: 'ç›´æ¨å¥–', amount: 99.9, rewardTime: '2025-09-03', targetMemberId: 7 },
                    { memberId: 1, name: 'å¼ ä¸‰', type: 'åŒºä»£å¥–', amount: 99.9, rewardTime: '2025-09-03', targetMemberId: 5 },
                    { memberId: 1, name: 'å¼ ä¸‰', type: 'ç³»ç»Ÿå¥–åŠ±', amount: 200, rewardTime: '2025-09-17', targetMemberId: 1 }
                ];
                
                demoRewards.forEach((rewardData, index) => {
                    let points = allocatePoints(rewardData.amount);
                    let reward = {
                        id: index + 1,
                        memberId: rewardData.memberId,
                        name: rewardData.name,
                        type: rewardData.type,
                        amount: rewardData.amount,
                        greenPoints: points.green,
                        redPoints: points.red,
                        rewardTime: rewardData.rewardTime,
                        targetMemberId: rewardData.targetMemberId
                    };
                    rewards.push(reward);
                });
                
                // ä¿å­˜æ•°æ®
                localStorage.setItem('members', JSON.stringify(members));
                localStorage.setItem('orders', JSON.stringify(orders));
                localStorage.setItem('rewards', JSON.stringify(rewards));
                
                refreshAllTables();
                
                showSuccessMessage('æ¼”ç¤ºæ•°æ®åˆ›å»ºæˆåŠŸï¼å·²åˆ›å»º13ä¸ªä¼šå‘˜ï¼ˆ1æ¨3ï¼Œ3æ¨9ç»“æ„ï¼‰ã€7ä¸ªè®¢å•å’Œ8ä¸ªå¥–åŠ±è®°å½•ã€‚');
            }
            
            // æ·»åŠ ä¼šå‘˜è¡¨å•æäº¤
            $('#addMemberForm').submit(function(e) {
                e.preventDefault();
                
                let members = JSON.parse(localStorage.getItem('members')) || [];
                
                let memberName = $('#memberName').val().trim();
                if (!memberName) {
                    showErrorMessage('è¯·è¾“å…¥ä¼šå‘˜å§“åï¼');
                    return;
                }
                
                let memberId = $('#memberId').val().trim();
                if (memberId) {
                    memberId = parseInt(memberId);
                    if (members.some(m => m.id === memberId)) {
                        showErrorMessage('ä¼šå‘˜IDå·²å­˜åœ¨ï¼Œè¯·æ›´æ¢IDï¼');
                        return;
                    }
                } else {
                    memberId = getMaxId(members) + 1;
                }
                
                let referrerId = $('#referrer').val().trim() ? parseInt($('#referrer').val()) : '';
                let contactPersonId = $('#contactPerson').val().trim() ? parseInt($('#contactPerson').val()) : '';
                let isReinvest = $('#isReinvest').val() === 'true';
                let registerTime = $('#registerTime').val();
                
                // éªŒè¯æ¨èäºº
                if (referrerId) {
                    let referrerExists = members.some(m => m.id === referrerId);
                    if (!referrerExists) {
                        showErrorMessage('æ¨èäººIDä¸å­˜åœ¨ï¼');
                        return;
                    }
                }
                
                // éªŒè¯æ¥ç‚¹äºº
                if (contactPersonId) {
                    let contactPersonExists = members.some(m => m.id === contactPersonId);
                    if (!contactPersonExists) {
                        showErrorMessage('æ¥ç‚¹äººIDä¸å­˜åœ¨ï¼');
                        return;
                    }
                }
                
                // åˆ›å»ºæ–°ä¼šå‘˜
                let newMember = {
                    id: memberId,
                    name: memberName,
                    referrer: referrerId || '',
                    contactPerson: contactPersonId || '',
                    directPush: 0,
                    level: 'ä¼šå‘˜',
                    repurchaseTimes: 0,
                    orderCount: 0,
                    totalPerformance: 0,
                    systemReward: 0,
                    directReward: 0,
                    areaReward: 0,
                    peerReward: 0,
                    cityReward: 0,
                    greenPoints: 0,
                    redPoints: 0,
                    totalIncome: 0,
                    registerTime: registerTime,
                    isReinvest: isReinvest,
                    isEmptyAccount: true
                };
                
                members.push(newMember);
                localStorage.setItem('members', JSON.stringify(members));
                
                refreshAllTables();
                $(this)[0].reset();
                $('#registerTime').val(formatDate(baseTime));
                
                showSuccessMessage(`ä¼šå‘˜ã€${newMember.name}ã€‘æ·»åŠ æˆåŠŸï¼IDï¼š${newMember.id}`);
            });
            
            // æ·»åŠ è®¢å•è¡¨å•æäº¤
            $('#addOrderForm').submit(function(e) {
                e.preventDefault();
                
                let orders = JSON.parse(localStorage.getItem('orders')) || [];
                let members = JSON.parse(localStorage.getItem('members')) || [];
                
                let memberId = parseInt($('#orderMemberId').val());
                let memberName = $('#orderMemberName').val().trim();
                
                if (!memberId) {
                    showErrorMessage('è¯·è¾“å…¥ä¼šå‘˜IDï¼');
                    return;
                }
                
                // éªŒè¯ä¼šå‘˜
                let member = members.find(m => m.id === memberId);
                if (!member) {
                    showErrorMessage('ä¼šå‘˜ä¸å­˜åœ¨ï¼');
                    return;
                }
                
                if (member.name !== memberName) {
                    showErrorMessage('ä¼šå‘˜å§“åä¸IDä¸åŒ¹é…ï¼');
                    return;
                }
                
                let orderId = getMaxId(orders) + 1;
                let orderNo = 'LG' + formatDateForOrderNo(new Date($('#orderTime').val())) + 
                             Math.floor(Math.random() * 10000).toString().padStart(4, '0');
                let orderType = $('#orderType').val();
                let orderTime = $('#orderTime').val();
                
                let newOrder = {
                    id: orderId,
                    memberId: memberId,
                    name: memberName,
                    amount: ORDER_PRICE,
                    type: orderType,
                    orderNo: orderNo,
                    orderTime: orderTime,
                    day16RewardStatus: orderType === 'å¤è´­è®¢å•' ? 'æ— ' : 'æœªåˆ°æ—¶é—´'
                };
                
                orders.push(newOrder);
                localStorage.setItem('orders', JSON.stringify(orders));
                
                // æ›´æ–°ä¼šå‘˜çŠ¶æ€ï¼ˆä¸å†æ˜¯ç©ºå·ï¼‰
                member.isEmptyAccount = false;
                member.orderCount = (member.orderCount || 0) + 1;
                localStorage.setItem('members', JSON.stringify(members));
                
                // è®¡ç®—å¥–åŠ±
                showLoading('æ­£åœ¨è®¡ç®—å¥–åŠ±...');
                setTimeout(() => {
                    calculateOrderRewardsOptimized(memberId, orderTime, memberName);
                    
                    setTimeout(() => {
                        refreshAllTables();
                        $(this)[0].reset();
                        $('#orderTime').val(formatDate(baseTime));
                        $('#orderAmount').val(ORDER_PRICE);
                        hideLoading();
                        
                        showSuccessMessage(`è®¢å•æ·»åŠ æˆåŠŸï¼è®¢å•ç¼–å·ï¼š${newOrder.orderNo}`);
                    }, 500);
                }, 100);
            });
            
            // æ·»åŠ å¥–åŠ±è¡¨å•æäº¤
            $('#addRewardForm').submit(function(e) {
                e.preventDefault();
                
                let rewards = JSON.parse(localStorage.getItem('rewards')) || [];
                let members = JSON.parse(localStorage.getItem('members')) || [];
                
                let memberId = parseInt($('#rewardMemberId').val());
                let memberName = $('#rewardMemberName').val().trim();
                let rewardAmount = parseFloat($('#rewardAmount').val());
                let rewardType = $('#rewardType').val();
                
                if (!memberId) {
                    showErrorMessage('è¯·è¾“å…¥ä¼šå‘˜IDï¼');
                    return;
                }
                
                // éªŒè¯ä¼šå‘˜
                let member = members.find(m => m.id === memberId);
                if (!member) {
                    showErrorMessage('ä¼šå‘˜ä¸å­˜åœ¨ï¼');
                    return;
                }
                
                if (member.name !== memberName) {
                    showErrorMessage('ä¼šå‘˜å§“åä¸IDä¸åŒ¹é…ï¼');
                    return;
                }
                
                if (member.isEmptyAccount) {
                    showErrorMessage('è¯¥ä¼šå‘˜æ˜¯ç©ºå·ï¼ˆæœªä¸‹å•ï¼‰ï¼Œæ— æ³•æ·»åŠ å¥–åŠ±ï¼');
                    return;
                }
                
                if (!rewardType) {
                    showErrorMessage('è¯·é€‰æ‹©å¥–åŠ±ç±»å‹ï¼');
                    return;
                }
                
                if (!rewardAmount || rewardAmount <= 0) {
                    showErrorMessage('è¯·è¾“å…¥æœ‰æ•ˆçš„å¥–åŠ±é‡‘é¢ï¼');
                    return;
                }
                
                let rewardId = getMaxId(rewards) + 1;
                let points = allocatePoints(rewardAmount);
                let targetMemberId = $('#targetMemberId').val().trim() ? parseInt($('#targetMemberId').val()) : '';
                
                let newReward = {
                    id: rewardId,
                    memberId: memberId,
                    name: memberName,
                    type: rewardType,
                    amount: rewardAmount,
                    greenPoints: points.green,
                    redPoints: points.red,
                    rewardTime: $('#rewardTime').val(),
                    targetMemberId: targetMemberId
                };
                
                rewards.push(newReward);
                localStorage.setItem('rewards', JSON.stringify(rewards));
                
                refreshAllTables();
                $(this)[0].reset();
                $('#rewardTime').val(formatDate(baseTime));
                
                showSuccessMessage(`å¥–åŠ±æ·»åŠ æˆåŠŸï¼ç»¿ç§¯åˆ†+${points.green.toFixed(2)} çº¢ç§¯åˆ†+${points.red.toFixed(2)}`);
                
                // æ£€æŸ¥è‡ªåŠ¨å¤è´­
                checkAutoRepurchase(memberId);
            });
            
            // ç­›é€‰å¥–åŠ±
            $('#filterRewardBtn').click(function() {
                let rewards = JSON.parse(localStorage.getItem('rewards')) || [];
                let filterId = $('#filterRewardId').val().trim() ? parseInt($('#filterRewardId').val()) : '';
                let filterName = $('#filterRewardName').val().trim();
                let filterType = $('#filterRewardType').val();
                let filterStart = $('#filterStartTime').val();
                let filterEnd = $('#filterEndTime').val();
                
                let filteredRewards = rewards.filter(reward => {
                    if (filterId && reward.id !== filterId) return false;
                    if (filterName && !reward.name.includes(filterName)) return false;
                    if (filterType && reward.type !== filterType) return false;
                    if (filterStart && reward.rewardTime < filterStart) return false;
                    if (filterEnd && reward.rewardTime > filterEnd) return false;
                    return true;
                });
                
                renderRewardTable(filteredRewards);
                
                if (filteredRewards.length === 0) {
                    showErrorMessage('æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„å¥–åŠ±è®°å½•ï¼');
                }
            });
            
            // ç”Ÿæˆç»Ÿè®¡æŠ¥è¡¨
            $('#statisticsBtn').click(function() {
                showLoading('æ­£åœ¨ç”Ÿæˆç»Ÿè®¡æŠ¥è¡¨...');
                setTimeout(() => {
                    refreshStatistics();
                    hideLoading();
                    showSuccessMessage('ç»Ÿè®¡æŠ¥è¡¨å·²ç”Ÿæˆï¼');
                }, 300);
            });
            
            // ================ å¯¼å…¥è®¢å•è‡ªåŠ¨è®¡ç®—å¥–åŠ±åŠŸèƒ½ ================
            
            // å¯¼å…¥è®¢å•æ•°æ®å¹¶è‡ªåŠ¨è®¡ç®—å¥–åŠ±
            $('#importOrderBtn').click(function() {
                let fileInput = $('#importOrderFile')[0];
                if (fileInput.files.length === 0) {
                    showErrorMessage('è¯·é€‰æ‹©è¦å¯¼å…¥çš„CSVæ–‡ä»¶ï¼');
                    return;
                }
                
                let file = fileInput.files[0];
                let reader = new FileReader();
                
                reader.onload = async function(e) {
                    try {
                        showLoading('æ­£åœ¨å¯¼å…¥è®¢å•æ•°æ®...');
                        updateLoading(10, 'è¯»å–æ–‡ä»¶å†…å®¹...');
                        
                        let csvContent = e.target.result;
                        if (csvContent.charCodeAt(0) === 0xFEFF) {
                            csvContent = csvContent.substring(1);
                        }
                        
                        updateLoading(20, 'è§£æCSVæ•°æ®...');
                        let lines = csvContent.split('\n').filter(line => line.trim() !== '');
                        if (lines.length <= 1) {
                            hideLoading();
                            showErrorMessage('CSVæ–‡ä»¶æ²¡æœ‰æ•°æ®ï¼');
                            return;
                        }
                        
                        // ç§»é™¤æ ‡é¢˜è¡Œ
                        let headers = lines[0].split(',').map(col => col.trim().replace(/"/g, ''));
                        lines.shift();
                        
                        updateLoading(30, 'éªŒè¯æ•°æ®æ ¼å¼...');
                        let orders = JSON.parse(localStorage.getItem('orders')) || [];
                        let members = JSON.parse(localStorage.getItem('members')) || [];
                        let rewards = JSON.parse(localStorage.getItem('rewards')) || [];
                        
                        let newOrders = [];
                        let updatedOrders = [];
                        let importCount = 0;
                        let updateCount = 0;
                        let errorCount = 0;
                        
                        updateLoading(40, 'å¤„ç†è®¢å•æ•°æ®...');
                        // å¤„ç†æ¯ä¸€è¡Œæ•°æ®
                        for (let i = 0; i < lines.length; i++) {
                            if (lines[i].trim() === '') continue;
                            
                            try {
                                // å¤„ç†CSVè¡Œï¼Œè€ƒè™‘å¼•å·å†…çš„é€—å·
                                let columns = parseCSVLine(lines[i]);
                                
                                if (columns.length >= 8) {
                                    let id = parseInt(columns[0]) || 0;
                                    let memberId = parseInt(columns[1]) || 0;
                                    let name = columns[2].trim();
                                    let amount = parseFloat(columns[3]) || ORDER_PRICE;
                                    let type = columns[4].trim() || 'æ™®é€šè®¢å•';
                                    let orderNo = columns[5].trim();
                                    let orderTime = columns[6].trim();
                                    let day16RewardStatus = columns[7].trim() || 'æœªåˆ°æ—¶é—´';
                                    
                                    // éªŒè¯ä¼šå‘˜æ˜¯å¦å­˜åœ¨
                                    let member = members.find(m => m.id === memberId);
                                    if (!member) {
                                        errorCount++;
                                        console.warn(`è®¢å•ID ${id}: ä¼šå‘˜ID ${memberId} ä¸å­˜åœ¨ï¼Œè·³è¿‡æ­¤è®¢å•`);
                                        continue;
                                    }
                                    
                                    // æ£€æŸ¥è®¢å•æ˜¯å¦å·²å­˜åœ¨
                                    let existingIndex = orders.findIndex(o => o.id === id);
                                    
                                    let orderData = {
                                        id: id,
                                        memberId: memberId,
                                        name: name,
                                        amount: amount,
                                        type: type,
                                        orderNo: orderNo || ('LG' + orderTime.replace(/-/g, '') + Math.floor(Math.random() * 10000).toString().padStart(4, '0')),
                                        orderTime: orderTime,
                                        day16RewardStatus: day16RewardStatus
                                    };
                                    
                                    if (existingIndex >= 0) {
                                        // æ›´æ–°ç°æœ‰è®¢å•
                                        orders[existingIndex] = orderData;
                                        updatedOrders.push(orderData);
                                        updateCount++;
                                    } else {
                                        // æ–°å¢è®¢å•
                                        orders.push(orderData);
                                        newOrders.push(orderData);
                                        importCount++;
                                        
                                        // æ›´æ–°ä¼šå‘˜çŠ¶æ€ï¼ˆä¸å†æ˜¯ç©ºå·ï¼‰
                                        member.isEmptyAccount = false;
                                        member.orderCount = (member.orderCount || 0) + 1;
                                    }
                                    
                                    updateLoading(40 + Math.floor((i / lines.length) * 30), `å·²å¤„ç† ${i + 1}/${lines.length} ä¸ªè®¢å•...`);
                                }
                            } catch (error) {
                                errorCount++;
                                console.error(`å¤„ç†ç¬¬${i+1}è¡Œæ—¶å‡ºé”™:`, error);
                            }
                        }
                        
                        updateLoading(70, 'ä¿å­˜è®¢å•æ•°æ®...');
                        localStorage.setItem('orders', JSON.stringify(orders));
                        localStorage.setItem('members', JSON.stringify(members));
                        
                        updateLoading(75, 'å¼€å§‹è®¡ç®—è®¢å•å¥–åŠ±...');
                        
                        // ä¸ºæ–°è®¢å•è®¡ç®—å¥–åŠ±
                        let rewardCalculations = [];
                        for (let i = 0; i < newOrders.length; i++) {
                            let order = newOrders[i];
                            updateLoading(75 + Math.floor((i / newOrders.length) * 20), `è®¡ç®—å¥–åŠ± ${i + 1}/${newOrders.length}...`);
                            
                            try {
                                // ä¸ºæ¯ä¸ªæ–°è®¢å•è®¡ç®—å¥–åŠ±
                                await calculateOrderRewardsForImport(order.memberId, order.orderTime, order.name);
                                rewardCalculations.push({
                                    orderId: order.id,
                                    memberId: order.memberId,
                                    success: true
                                });
                            } catch (error) {
                                rewardCalculations.push({
                                    orderId: order.id,
                                    memberId: order.memberId,
                                    success: false,
                                    error: error.message
                                });
                                errorCount++;
                            }
                        }
                        
                        updateLoading(95, 'åˆ·æ–°æ•°æ®è¡¨æ ¼...');
                        refreshAllTables();
                        
                        updateLoading(100, 'å¯¼å…¥å®Œæˆï¼');
                        setTimeout(() => {
                            hideLoading();
                            
                            // æ˜¾ç¤ºå¯¼å…¥ç»“æœ
                            let message = `è®¢å•æ•°æ®å¯¼å…¥å®Œæˆï¼`;
                            message += `\næ–°å¢è®¢å•: ${importCount} ä¸ª`;
                            message += `\næ›´æ–°è®¢å•: ${updateCount} ä¸ª`;
                            message += `\næˆåŠŸè®¡ç®—å¥–åŠ±: ${rewardCalculations.filter(r => r.success).length} ä¸ª`;
                            message += `\né”™è¯¯/è·³è¿‡: ${errorCount} ä¸ª`;
                            
                            if (errorCount > 0) {
                                showErrorMessage(message);
                            } else {
                                showSuccessMessage(message);
                            }
                            
                            $('#importOrderFile').val('');
                        }, 500);
                        
                    } catch (error) {
                        hideLoading();
                        showErrorMessage(`å¯¼å…¥å¤±è´¥ï¼š${error.message}`);
                        console.error('å¯¼å…¥é”™è¯¯:', error);
                    }
                };
                
                reader.onerror = function() {
                    hideLoading();
                    showErrorMessage('æ–‡ä»¶è¯»å–å¤±è´¥ï¼');
                };
                
                reader.readAsText(file, 'UTF-8');
            });
            
            // è§£æCSVè¡Œçš„è¾…åŠ©å‡½æ•°ï¼ˆå¤„ç†å¼•å·å†…çš„é€—å·ï¼‰
            function parseCSVLine(line) {
                let result = [];
                let inQuotes = false;
                let currentField = '';
                
                for (let i = 0; i < line.length; i++) {
                    let char = line[i];
                    
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        result.push(currentField);
                        currentField = '';
                    } else {
                        currentField += char;
                    }
                }
                
                // æ·»åŠ æœ€åä¸€ä¸ªå­—æ®µ
                result.push(currentField);
                
                // ç§»é™¤å­—æ®µå‰åçš„å¼•å·
                return result.map(field => field.replace(/^"|"$/g, '').trim());
            }
            
            // ä¸ºå¯¼å…¥è®¢å•è®¡ç®—å¥–åŠ±çš„å‡½æ•°ï¼ˆæ— UIå¹²æ‰°ï¼‰
            async function calculateOrderRewardsForImport(memberId, orderTime, memberName) {
                return new Promise((resolve) => {
                    // ç›´æ¥è°ƒç”¨å¥–åŠ±è®¡ç®—å‡½æ•°ï¼Œä½†ä¸æ›´æ–°UI
                    setTimeout(() => {
                        // è®¡ç®—ç›´æ¨å¥–
                        let members = JSON.parse(localStorage.getItem('members')) || [];
                        let rewards = JSON.parse(localStorage.getItem('rewards')) || [];
                        let member = members.find(m => m.id === memberId);
                        if (!member) {
                            resolve();
                            return;
                        }
                        
                        // ç›´æ¨å¥–ï¼ˆç»™æ¨èäººï¼‰
                        if (member.referrer) {
                            let referrer = members.find(m => m.id === member.referrer);
                            if (referrer && !referrer.isEmptyAccount) {
                                let directRewardAmount = ORDER_PRICE * 0.05;
                                
                                // å¦‚æœæ¨èäººæ˜¯åŒºä»£ï¼Œéœ€è¦è€ƒè™‘æ¯æ—¥å°é¡¶
                                if (referrer.level === 'åŒºä»£') {
                                    let todayTotal = rewards
                                        .filter(r => r.memberId === referrer.id && 
                                                    r.rewardTime === orderTime &&
                                                    ['ç›´æ¨å¥–', 'å¹³çº§å¥–', 'åŒºä»£å¥–'].includes(r.type))
                                        .reduce((sum, r) => sum + r.amount, 0);
                                    
                                    let remaining = AREA_AGENT_DAILY_CAP - todayTotal;
                                    
                                    if (remaining > 0) {
                                        let actualReward = Math.min(directRewardAmount, remaining);
                                        addRewardRecord(
                                            referrer.id,
                                            referrer.name,
                                            'ç›´æ¨å¥–',
                                            actualReward,
                                            orderTime,
                                            memberId
                                        );
                                    }
                                } else {
                                    // éåŒºä»£ï¼Œæ­£å¸¸å‘æ”¾
                                    addRewardRecord(
                                        referrer.id,
                                        referrer.name,
                                        'ç›´æ¨å¥–',
                                        directRewardAmount,
                                        orderTime,
                                        memberId
                                    );
                                }
                            }
                        }
                        
                        // åŒºä»£å¥–
                        let areaAgents = getUpperAreaAgentsOptimized(memberId);
                        areaAgents.forEach(agentId => {
                            let agent = members.find(m => m.id === agentId);
                            if (agent && !agent.isEmptyAccount && agent.level === 'åŒºä»£') {
                                let areaReward = calculateAreaReward(agentId, orderTime);
                                if (areaReward > 0) {
                                    addRewardRecord(
                                        agentId,
                                        agent.name,
                                        'åŒºä»£å¥–',
                                        areaReward,
                                        orderTime,
                                        memberId
                                    );
                                }
                            }
                        });
                        
                        // å¹³çº§å¥–
                        areaAgents.forEach(agentId => {
                            let agent = members.find(m => m.id === agentId);
                            if (agent && !agent.isEmptyAccount && agent.level === 'åŒºä»£') {
                                let upperAreaAgentId = getUpperAreaAgentForPeerRewardOptimized(agentId);
                                if (upperAreaAgentId) {
                                    let upperAgent = members.find(m => m.id === upperAreaAgentId);
                                    if (upperAgent && upperAgent.level === 'åŒºä»£' && !upperAgent.isEmptyAccount) {
                                        let areaRewardToday = rewards
                                            .filter(r => r.memberId === agentId && 
                                                        r.rewardTime === orderTime &&
                                                        r.type === 'åŒºä»£å¥–')
                                            .reduce((sum, r) => sum + r.amount, 0);
                                        
                                        let peerRewardAmount = areaRewardToday;
                                        
                                        let todayTotal = rewards
                                            .filter(r => r.memberId === upperAreaAgentId && 
                                                        r.rewardTime === orderTime &&
                                                        ['ç›´æ¨å¥–', 'å¹³çº§å¥–', 'åŒºä»£å¥–'].includes(r.type))
                                            .reduce((sum, r) => sum + r.amount, 0);
                                        
                                        let remaining = AREA_AGENT_DAILY_CAP - todayTotal;
                                        
                                        if (remaining > 0 && peerRewardAmount > 0) {
                                            let actualReward = Math.min(peerRewardAmount, remaining);
                                            addRewardRecord(
                                                upperAreaAgentId,
                                                upperAgent.name,
                                                'å¹³çº§å¥–',
                                                actualReward,
                                                orderTime,
                                                agentId
                                            );
                                        }
                                    }
                                }
                            }
                        });
                        
                        // å¸‚ä»£å¥–
                        let cityAgents = getUpperCityAgentsOptimized(memberId);
                        cityAgents.forEach(agentId => {
                            let agent = members.find(m => m.id === agentId);
                            if (agent && !agent.isEmptyAccount && agent.level === 'å¸‚ä»£') {
                                let cityReward = ORDER_PRICE * 0.03;
                                addRewardRecord(
                                    agentId,
                                    agent.name,
                                    'å¸‚ä»£å¥–',
                                    cityReward,
                                    orderTime,
                                    memberId
                                );
                            }
                        });
                        
                        // æ£€æŸ¥è‡ªåŠ¨å¤è´­
                        checkAutoRepurchase(memberId);
                        
                        resolve();
                    }, 50);
                });
            }
            
            // CSVä¸‹è½½å‡½æ•°
            function downloadCSV(csvContent, fileName) {
                let blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
                let link = document.createElement("a");
                let url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", fileName);
                link.style.display = "none";
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            }
            
            // å¯¼å‡ºä¼šå‘˜æ•°æ®
            $('#exportMemberBtn').click(function() {
                let members = JSON.parse(localStorage.getItem('members')) || [];
                let csvContent = "ID,å§“å,æ¨èäºº,æ¥ç‚¹äºº,ç›´æ¨æ•°é‡,çº§åˆ«,å¤è´­æ¬¡æ•°,å¤æŠ•,ç´¯è®¡ä¸šç»©,ç³»ç»Ÿå¥–,ç›´æ¨å¥–,åŒºä»£å¥–,å¹³çº§å¥–,å¸‚ä»£å¥–,ç»¿ç§¯åˆ†,çº¢ç§¯åˆ†,ç´¯è®¡æ”¶ç›Š,æ³¨å†Œæ—¶é—´,æ˜¯å¦ç©ºå·\n";
                
                members.forEach(member => {
                    let isReinvestText = member.isReinvest ? 'æ˜¯' : 'å¦';
                    let isEmptyAccountText = member.isEmptyAccount ? 'æ˜¯' : 'å¦';
                    let totalIncome = (member.systemReward + member.directReward + member.areaReward + member.peerReward + member.cityReward).toFixed(2);
                    
                    csvContent += `${member.id},${member.name},${member.referrer || ''},${member.contactPerson || ''},${member.directPush},${member.level},${member.repurchaseTimes},${isReinvestText},${member.totalPerformance},${member.systemReward},${member.directReward},${member.areaReward},${member.peerReward},${member.cityReward},${member.greenPoints},${member.redPoints},${totalIncome},${member.registerTime},${isEmptyAccountText}\n`;
                });
                
                downloadCSV(csvContent, 'å‡Œå† ä¼šå‘˜ä¿¡æ¯è¡¨.csv');
                showSuccessMessage('ä¼šå‘˜ä¿¡æ¯è¡¨å¯¼å‡ºæˆåŠŸï¼');
            });
            
            // å¯¼å‡ºè®¢å•æ•°æ®
            $('#exportOrderBtn').click(function() {
                let orders = JSON.parse(localStorage.getItem('orders')) || [];
                let csvContent = "ID,ä¼šå‘˜ID,å§“å,ä¸‹å•é‡‘é¢,è®¢å•ç±»å‹,è®¢å•ç¼–å·,ä¸‹å•æ—¶é—´,16å¤©å¥–åŠ±çŠ¶æ€\n";
                
                orders.forEach(order => {
                    let rewardStatus = order.day16RewardStatus || 'æœªåˆ°æ—¶é—´';
                    if (order.type === 'å¤è´­è®¢å•') rewardStatus = 'æ— ';
                    
                    csvContent += `${order.id},${order.memberId},${order.name},${order.amount},${order.type},${order.orderNo},${order.orderTime},${rewardStatus}\n`;
                });
                
                downloadCSV(csvContent, 'å‡Œå† è®¢å•è¡¨.csv');
                showSuccessMessage('è®¢å•è¡¨å¯¼å‡ºæˆåŠŸï¼');
            });
            
            // å¯¼å‡ºå¥–åŠ±æ•°æ®
            $('#exportRewardBtn').click(function() {
                let rewards = JSON.parse(localStorage.getItem('rewards')) || [];
                let csvContent = "ID,ä¼šå‘˜ID,å§“å,å¥–åŠ±ç±»å‹,å¥–åŠ±æ•°é‡,ç»¿ç§¯åˆ†,çº¢ç§¯åˆ†,å¥–åŠ±æ—¶é—´,å¯¹æ–¹ID\n";
                
                rewards.forEach(reward => {
                    csvContent += `${reward.id},${reward.memberId},${reward.name},${reward.type},${reward.amount},${reward.greenPoints},${reward.redPoints},${reward.rewardTime},${reward.targetMemberId || ''}\n`;
                });
                
                downloadCSV(csvContent, 'å‡Œå† ç§¯åˆ†å¥–åŠ±è¡¨.csv');
                showSuccessMessage('ç§¯åˆ†å¥–åŠ±è¡¨å¯¼å‡ºæˆåŠŸï¼');
            });
            
            // å¯¼å‡ºç»Ÿè®¡æŠ¥è¡¨
            $('#exportStatisticsBtn').click(function() {
                refreshStatistics();
                
                // ç”Ÿæˆè¯¦ç»†ç»Ÿè®¡CSV
                let csvContent = "æ—¥æœŸ,æ™®é€šè®¢å•,å¤è´­è®¢å•,æ€»è®¢å•æ•°,æ€»é‡‘é¢,16å¤©å¥–åŠ±,ç³»ç»Ÿå¥–åŠ±,ç›´æ¨å¥–,åŒºä»£å¥–,å¹³çº§å¥–,å¸‚ä»£å¥–,æ€»å¥–åŠ±,ç»¿ç§¯åˆ†,çº¢ç§¯åˆ†\n";
                
                let orders = JSON.parse(localStorage.getItem('orders')) || [];
                let rewards = JSON.parse(localStorage.getItem('rewards')) || [];
                
                // è·å–æ‰€æœ‰æ—¥æœŸ
                let allDates = new Set();
                orders.forEach(order => allDates.add(order.orderTime));
                rewards.forEach(reward => allDates.add(reward.rewardTime));
                
                let sortedDates = Array.from(allDates).sort();
                
                sortedDates.forEach(date => {
                    let stats = {
                        normalOrders: 0,
                        repurchaseOrders: 0,
                        totalOrders: 0,
                        totalAmount: 0,
                        day16Rewards: 0,
                        systemRewards: 0,
                        directRewards: 0,
                        areaRewards: 0,
                        peerRewards: 0,
                        cityRewards: 0,
                        totalRewards: 0,
                        greenPoints: 0,
                        redPoints: 0
                    };
                    
                    // ç»Ÿè®¡å½“å¤©è®¢å•
                    orders.filter(o => o.orderTime === date).forEach(order => {
                        if (order.type === 'æ™®é€šè®¢å•') {
                            stats.normalOrders++;
                        } else {
                            stats.repurchaseOrders++;
                        }
                        stats.totalOrders++;
                        stats.totalAmount += order.amount;
                        
                        if (order.day16RewardStatus === 'å·²å‘æ”¾') {
                            stats.day16Rewards += DAY16_REWARD;
                            stats.systemRewards += DAY16_REWARD;
                        }
                    });
                    
                    // ç»Ÿè®¡å½“å¤©å¥–åŠ±
                    rewards.filter(r => r.rewardTime === date).forEach(reward => {
                        switch(reward.type) {
                            case 'ç³»ç»Ÿå¥–åŠ±':
                                stats.systemRewards += reward.amount;
                                break;
                            case 'ç›´æ¨å¥–':
                                stats.directRewards += reward.amount;
                                break;
                            case 'åŒºä»£å¥–':
                                stats.areaRewards += reward.amount;
                                break;
                            case 'å¹³çº§å¥–':
                                stats.peerRewards += reward.amount;
                                break;
                            case 'å¸‚ä»£å¥–':
                                stats.cityRewards += reward.amount;
                                break;
                        }
                        stats.totalRewards += reward.amount;
                        stats.greenPoints += reward.greenPoints;
                        stats.redPoints += reward.redPoints;
                    });
                    
                    csvContent += `${date},${stats.normalOrders},${stats.repurchaseOrders},${stats.totalOrders},${stats.totalAmount.toFixed(2)},${stats.day16Rewards.toFixed(2)},${stats.systemRewards.toFixed(2)},${stats.directRewards.toFixed(2)},${stats.areaRewards.toFixed(2)},${stats.peerRewards.toFixed(2)},${stats.cityRewards.toFixed(2)},${stats.totalRewards.toFixed(2)},${stats.greenPoints.toFixed(2)},${stats.redPoints.toFixed(2)}\n`;
                });
                
                downloadCSV(csvContent, 'å‡Œå† ç»Ÿè®¡æŠ¥è¡¨.csv');
                showSuccessMessage('ç»Ÿè®¡æŠ¥è¡¨å¯¼å‡ºæˆåŠŸï¼');
            });
            
            // å¯¼å‡ºæ‰€æœ‰æ•°æ®
            $('#exportAllBtn').click(function() {
                $('#exportMemberBtn').click();
                setTimeout(() => $('#exportOrderBtn').click(), 500);
                setTimeout(() => $('#exportRewardBtn').click(), 1000);
                setTimeout(() => $('#exportStatisticsBtn').click(), 1500);
                setTimeout(() => showSuccessMessage('æ‰€æœ‰æ•°æ®å·²å¯¼å‡ºå®Œæˆï¼'), 2000);
            });
            
            // å¯¼å…¥ä¼šå‘˜æ•°æ®
            $('#importMemberBtn').click(function() {
                let fileInput = $('#importMemberFile')[0];
                if (fileInput.files.length === 0) {
                    showErrorMessage('è¯·é€‰æ‹©è¦å¯¼å…¥çš„CSVæ–‡ä»¶ï¼');
                    return;
                }
                
                let file = fileInput.files[0];
                let reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        showLoading('æ­£åœ¨å¯¼å…¥ä¼šå‘˜æ•°æ®...');
                        updateLoading(30, 'è¯»å–æ–‡ä»¶...');
                        
                        let csvContent = e.target.result;
                        // ç§»é™¤BOMå¤´
                        if (csvContent.charCodeAt(0) === 0xFEFF) {
                            csvContent = csvContent.substring(1);
                        }
                        
                        updateLoading(50, 'è§£ææ•°æ®...');
                        let lines = csvContent.split('\n').filter(line => line.trim() !== '');
                        // ç§»é™¤æ ‡é¢˜è¡Œ
                        lines.shift();
                        
                        let members = JSON.parse(localStorage.getItem('members')) || [];
                        let importCount = 0;
                        let updateCount = 0;
                        
                        lines.forEach(line => {
                            if (line.trim() === '') return;
                            
                            let columns = line.split(',').map(col => col.replace(/^"|"$/g, '').trim());
                            
                            if (columns.length >= 19) {
                                let id = parseInt(columns[0]) || 0;
                                let existingIndex = members.findIndex(m => m.id === id);
                                
                                let memberData = {
                                    id: id,
                                    name: columns[1],
                                    referrer: columns[2] ? parseInt(columns[2]) : '',
                                    contactPerson: columns[3] ? parseInt(columns[3]) : '',
                                    directPush: parseInt(columns[4]) || 0,
                                    level: columns[5],
                                    repurchaseTimes: parseInt(columns[6]) || 0,
                                    isReinvest: columns[7] === 'æ˜¯',
                                    totalPerformance: parseInt(columns[8]) || 0,
                                    systemReward: parseFloat(columns[9]) || 0,
                                    directReward: parseFloat(columns[10]) || 0,
                                    areaReward: parseFloat(columns[11]) || 0,
                                    peerReward: parseFloat(columns[12]) || 0,
                                    cityReward: parseFloat(columns[13]) || 0,
                                    greenPoints: parseFloat(columns[14]) || 0,
                                    redPoints: parseFloat(columns[15]) || 0,
                                    totalIncome: parseFloat(columns[16]) || 0,
                                    registerTime: columns[17],
                                    isEmptyAccount: columns[18] === 'æ˜¯',
                                    orderCount: 0
                                };
                                
                                if (existingIndex >= 0) {
                                    members[existingIndex] = memberData;
                                    updateCount++;
                                } else {
                                    members.push(memberData);
                                    importCount++;
                                }
                            }
                        });
                        
                        updateLoading(80, 'ä¿å­˜æ•°æ®...');
                        localStorage.setItem('members', JSON.stringify(members));
                        
                        updateLoading(90, 'åˆ·æ–°ç•Œé¢...');
                        refreshAllTables();
                        
                        updateLoading(100, 'å¯¼å…¥å®Œæˆï¼');
                        setTimeout(() => {
                            hideLoading();
                            showSuccessMessage(`ä¼šå‘˜æ•°æ®å¯¼å…¥æˆåŠŸï¼æ–°å¢: ${importCount} æ¡ï¼Œæ›´æ–°: ${updateCount} æ¡`);
                            $('#importMemberFile').val('');
                        }, 500);
                    } catch (error) {
                        hideLoading();
                        showErrorMessage(`å¯¼å…¥å¤±è´¥ï¼š${error.message}`);
                        console.error('å¯¼å…¥é”™è¯¯:', error);
                    }
                };
                
                reader.onerror = function() {
                    hideLoading();
                    showErrorMessage('æ–‡ä»¶è¯»å–å¤±è´¥ï¼');
                };
                
                reader.readAsText(file, 'UTF-8');
            });
            
            // å¯¼å…¥å¥–åŠ±æ•°æ®
            $('#importRewardBtn').click(function() {
                let fileInput = $('#importRewardFile')[0];
                if (fileInput.files.length === 0) {
                    showErrorMessage('è¯·é€‰æ‹©è¦å¯¼å…¥çš„CSVæ–‡ä»¶ï¼');
                    return;
                }
                
                let file = fileInput.files[0];
                let reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        showLoading('æ­£åœ¨å¯¼å…¥å¥–åŠ±æ•°æ®...');
                        updateLoading(30, 'è¯»å–æ–‡ä»¶...');
                        
                        let csvContent = e.target.result;
                        if (csvContent.charCodeAt(0) === 0xFEFF) {
                            csvContent = csvContent.substring(1);
                        }
                        
                        updateLoading(50, 'è§£ææ•°æ®...');
                        let lines = csvContent.split('\n').filter(line => line.trim() !== '');
                        lines.shift();
                        
                        let rewards = JSON.parse(localStorage.getItem('rewards')) || [];
                        let importCount = 0;
                        let updateCount = 0;
                        
                        lines.forEach(line => {
                            if (line.trim() === '') return;
                            
                            let columns = line.split(',').map(col => col.replace(/^"|"$/g, '').trim());
                            
                            if (columns.length >= 9) {
                                let id = parseInt(columns[0]) || 0;
                                let existingIndex = rewards.findIndex(r => r.id === id);
                                
                                let rewardData = {
                                    id: id,
                                    memberId: parseInt(columns[1]) || 0,
                                    name: columns[2],
                                    type: columns[3],
                                    amount: parseFloat(columns[4]) || 0,
                                    greenPoints: parseFloat(columns[5]) || 0,
                                    redPoints: parseFloat(columns[6]) || 0,
                                    rewardTime: columns[7],
                                    targetMemberId: columns[8] ? parseInt(columns[8]) : ''
                                };
                                
                                if (existingIndex >= 0) {
                                    rewards[existingIndex] = rewardData;
                                    updateCount++;
                                } else {
                                    rewards.push(rewardData);
                                    importCount++;
                                }
                            }
                        });
                        
                        updateLoading(80, 'ä¿å­˜æ•°æ®...');
                        localStorage.setItem('rewards', JSON.stringify(rewards));
                        
                        updateLoading(90, 'åˆ·æ–°ç•Œé¢...');
                        refreshAllTables();
                        
                        updateLoading(100, 'å¯¼å…¥å®Œæˆï¼');
                        setTimeout(() => {
                            hideLoading();
                            showSuccessMessage(`å¥–åŠ±æ•°æ®å¯¼å…¥æˆåŠŸï¼æ–°å¢: ${importCount} æ¡ï¼Œæ›´æ–°: ${updateCount} æ¡`);
                            $('#importRewardFile').val('');
                        }, 500);
                    } catch (error) {
                        hideLoading();
                        showErrorMessage(`å¯¼å…¥å¤±è´¥ï¼š${error.message}`);
                        console.error('å¯¼å…¥é”™è¯¯:', error);
                    }
                };
                
                reader.onerror = function() {
                    hideLoading();
                    showErrorMessage('æ–‡ä»¶è¯»å–å¤±è´¥ï¼');
                };
                
                reader.readAsText(file, 'UTF-8');
            });
            
            // æ¸…ç©ºæ•°æ®
            $('#clearMemberBtn').click(function() {
                if (confirm('ç¡®å®šè¦æ¸…ç©ºä¼šå‘˜ä¿¡æ¯è¡¨å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                    localStorage.setItem('members', JSON.stringify([]));
                    refreshAllTables();
                    showSuccessMessage('ä¼šå‘˜ä¿¡æ¯è¡¨å·²æ¸…ç©ºï¼');
                }
            });
            
            $('#clearOrderBtn').click(function() {
                if (confirm('ç¡®å®šè¦æ¸…ç©ºè®¢å•è¡¨å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                    localStorage.setItem('orders', JSON.stringify([]));
                    refreshAllTables();
                    showSuccessMessage('è®¢å•è¡¨å·²æ¸…ç©ºï¼');
                }
            });
            
            $('#clearRewardBtn').click(function() {
                if (confirm('ç¡®å®šè¦æ¸…ç©ºç§¯åˆ†å¥–åŠ±è¡¨å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                    localStorage.setItem('rewards', JSON.stringify([]));
                    refreshAllTables();
                    showSuccessMessage('ç§¯åˆ†å¥–åŠ±è¡¨å·²æ¸…ç©ºï¼');
                }
            });
            
            $('#clearAllBtn').click(function() {
                if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰è¡¨æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                    localStorage.setItem('members', JSON.stringify([]));
                    localStorage.setItem('orders', JSON.stringify([]));
                    localStorage.setItem('rewards', JSON.stringify([]));
                    refreshAllTables();
                    showSuccessMessage('æ‰€æœ‰è¡¨æ•°æ®å·²æ¸…ç©ºï¼');
                }
            });
            
            // ç¼–è¾‘ä¼šå‘˜
            $(document).on('click', '.edit-member', function() {
                let memberId = $(this).data('id');
                let members = JSON.parse(localStorage.getItem('members')) || [];
                let member = members.find(m => m.id === memberId);
                
                if (member) {
                    $('#editMemberId').val(member.id);
                    $('#editMemberName').val(member.name);
                    $('#editReferrer').val(member.referrer || '');
                    $('#editContactPerson').val(member.contactPerson || '');
                    $('#editDirectPush').val(member.directPush || 0);
                    $('#editMemberLevel').val(member.level);
                    $('#editIsReinvest').val(member.isReinvest ? 'true' : 'false');
                    $('#editRepurchaseTimes').val(member.repurchaseTimes || 0);
                    $('#editOrderCount').val(member.orderCount || 0);
                    $('#editTotalPerformance').val(member.totalPerformance || 0);
                    $('#editSystemReward').val(member.systemReward || 0);
                    $('#editDirectReward').val(member.directReward || 0);
                    $('#editAreaReward').val(member.areaReward || 0);
                    $('#editPeerReward').val(member.peerReward || 0);
                    $('#editCityReward').val(member.cityReward || 0);
                    $('#editGreenPoints').val(member.greenPoints || 0);
                    $('#editRedPoints').val(member.redPoints || 0);
                    $('#editTotalIncome').val(member.totalIncome || 0);
                    $('#editIsEmptyAccount').val(member.isEmptyAccount ? 'true' : 'false');
                    $('#editRegisterTime').val(member.registerTime);
                    
                    $('#editMemberModal').modal('show');
                }
            });
            
            $('#saveMemberEdit').click(function() {
                let members = JSON.parse(localStorage.getItem('members')) || [];
                let memberId = parseInt($('#editMemberId').val());
                let member = members.find(m => m.id === memberId);
                
                if (member) {
                    member.name = $('#editMemberName').val();
                    member.referrer = $('#editReferrer').val() ? parseInt($('#editReferrer').val()) : '';
                    member.contactPerson = $('#editContactPerson').val() ? parseInt($('#editContactPerson').val()) : '';
                    member.level = $('#editMemberLevel').val();
                    member.isReinvest = $('#editIsReinvest').val() === 'true';
                    member.repurchaseTimes = parseInt($('#editRepurchaseTimes').val()) || 0;
                    member.systemReward = parseFloat($('#editSystemReward').val()) || 0;
                    member.directReward = parseFloat($('#editDirectReward').val()) || 0;
                    member.areaReward = parseFloat($('#editAreaReward').val()) || 0;
                    member.peerReward = parseFloat($('#editPeerReward').val()) || 0;
                    member.cityReward = parseFloat($('#editCityReward').val()) || 0;
                    member.greenPoints = parseFloat($('#editGreenPoints').val()) || 0;
                    member.redPoints = parseFloat($('#editRedPoints').val()) || 0;
                    member.totalIncome = parseFloat($('#editTotalIncome').val()) || 0;
                    member.isEmptyAccount = $('#editIsEmptyAccount').val() === 'true';
                    member.registerTime = $('#editRegisterTime').val();
                    
                    localStorage.setItem('members', JSON.stringify(members));
                    refreshAllTables();
                    $('#editMemberModal').modal('hide');
                    showSuccessMessage('ä¼šå‘˜ä¿¡æ¯æ›´æ–°æˆåŠŸï¼');
                }
            });
            
            // åˆ é™¤ä¼šå‘˜
            $(document).on('click', '.delete-member', function() {
                let memberId = $(this).data('id');
                if (confirm('ç¡®å®šè¦åˆ é™¤æ­¤ä¼šå‘˜å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                    let members = JSON.parse(localStorage.getItem('members')) || [];
                    members = members.filter(m => m.id !== memberId);
                    localStorage.setItem('members', JSON.stringify(members));
                    refreshAllTables();
                    showSuccessMessage('ä¼šå‘˜åˆ é™¤æˆåŠŸï¼');
                }
            });
            
            // ç¼–è¾‘è®¢å•
            $(document).on('click', '.edit-order', function() {
                let orderId = $(this).data('id');
                let orders = JSON.parse(localStorage.getItem('orders')) || [];
                let order = orders.find(o => o.id === orderId);
                
                if (order) {
                    $('#editOrderId').val(order.id);
                    $('#editOrderMemberId').val(order.memberId);
                    $('#editOrderMemberName').val(order.name);
                    $('#editOrderAmount').val(order.amount);
                    $('#editOrderType').val(order.type);
                    $('#editOrderTime').val(order.orderTime);
                    $('#edit16DayRewardStatus').val(order.day16RewardStatus || 'æœªåˆ°æ—¶é—´');
                    
                    $('#editOrderModal').modal('show');
                }
            });
            
            $('#saveOrderEdit').click(function() {
                let orders = JSON.parse(localStorage.getItem('orders')) || [];
                let orderId = parseInt($('#editOrderId').val());
                let order = orders.find(o => o.id === orderId);
                
                if (order) {
                    order.memberId = parseInt($('#editOrderMemberId').val());
                    order.name = $('#editOrderMemberName').val();
                    order.type = $('#editOrderType').val();
                    order.orderTime = $('#editOrderTime').val();
                    order.day16RewardStatus = $('#edit16DayRewardStatus').val();
                    
                    localStorage.setItem('orders', JSON.stringify(orders));
                    refreshAllTables();
                    $('#editOrderModal').modal('hide');
                    showSuccessMessage('è®¢å•ä¿¡æ¯æ›´æ–°æˆåŠŸï¼');
                }
            });
            
            // åˆ é™¤è®¢å•
            $(document).on('click', '.delete-order', function() {
                let orderId = $(this).data('id');
                if (confirm('ç¡®å®šè¦åˆ é™¤æ­¤è®¢å•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                    let orders = JSON.parse(localStorage.getItem('orders')) || [];
                    orders = orders.filter(o => o.id !== orderId);
                    localStorage.setItem('orders', JSON.stringify(orders));
                    refreshAllTables();
                    showSuccessMessage('è®¢å•åˆ é™¤æˆåŠŸï¼');
                }
            });
            
            // ç¼–è¾‘å¥–åŠ±
            $(document).on('click', '.edit-reward', function() {
                let rewardId = $(this).data('id');
                let rewards = JSON.parse(localStorage.getItem('rewards')) || [];
                let reward = rewards.find(r => r.id === rewardId);
                
                if (reward) {
                    $('#editRewardId').val(reward.id);
                    $('#editRewardMemberId').val(reward.memberId);
                    $('#editRewardMemberName').val(reward.name);
                    $('#editRewardType').val(reward.type);
                    $('#editRewardAmount').val(reward.amount);
                    $('#editRewardTime').val(reward.rewardTime);
                    $('#editTargetMemberId').val(reward.targetMemberId || '');
                    
                    $('#editRewardModal').modal('show');
                }
            });
            
            $('#saveRewardEdit').click(function() {
                let rewards = JSON.parse(localStorage.getItem('rewards')) || [];
                let rewardId = parseInt($('#editRewardId').val());
                let reward = rewards.find(r => r.id === rewardId);
                
                if (reward) {
                    reward.memberId = parseInt($('#editRewardMemberId').val());
                    reward.name = $('#editRewardMemberName').val();
                    reward.type = $('#editRewardType').val();
                    reward.amount = parseFloat($('#editRewardAmount').val());
                    reward.rewardTime = $('#editRewardTime').val();
                    reward.targetMemberId = $('#editTargetMemberId').val() ? parseInt($('#editTargetMemberId').val()) : '';
                    
                    // é‡æ–°è®¡ç®—ç§¯åˆ†
                    let points = allocatePoints(reward.amount);
                    reward.greenPoints = points.green;
                    reward.redPoints = points.red;
                    
                    localStorage.setItem('rewards', JSON.stringify(rewards));
                    refreshAllTables();
                    $('#editRewardModal').modal('hide');
                    showSuccessMessage('å¥–åŠ±ä¿¡æ¯æ›´æ–°æˆåŠŸï¼');
                }
            });
            
            // åˆ é™¤å¥–åŠ±
            $(document).on('click', '.delete-reward', function() {
                let rewardId = $(this).data('id');
                if (confirm('ç¡®å®šè¦åˆ é™¤æ­¤å¥–åŠ±è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                    let rewards = JSON.parse(localStorage.getItem('rewards')) || [];
                    rewards = rewards.filter(r => r.id !== rewardId);
                    localStorage.setItem('rewards', JSON.stringify(rewards));
                    refreshAllTables();
                    showSuccessMessage('å¥–åŠ±è®°å½•åˆ é™¤æˆåŠŸï¼');
                }
            });
            
            // åˆå§‹åŒ–æ˜¾ç¤º
            updateBaseTimeDisplay();
            refreshAllTables();
        });
    </script>
</body>
</html>